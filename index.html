<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì •ìš°ì˜ í¬ì¼“ëª¬ RPG</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Malgun Gothic', sans-serif; background: #000; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        canvas { display: block; touch-action: none; }
        .hud { position: absolute; top: 8px; left: 8px; z-index: 10; display: none; }
        .hud.show { display: block; }
        .hud-box { background: rgba(0,0,0,0.85); padding: 8px 12px; border-radius: 10px; border: 2px solid #ffd700; color: #fff; font-size: 11px; }
        .hud-row { display: flex; align-items: center; gap: 6px; margin: 2px 0; }
        .hud-icon { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #ffd700; }
        .hud-name { color: #ffd700; font-weight: bold; }
        .hud-lv { background: #c0392b; padding: 1px 6px; border-radius: 8px; font-size: 9px; margin-left: 4px; }
        .bar { width: 70px; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; }
        .bar-hp { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .bar-mp { background: linear-gradient(90deg, #2980b9, #3498db); }
        .bar-exp { background: linear-gradient(90deg, #8e44ad, #9b59b6); }
        .hud-stats { display: flex; gap: 8px; margin-top: 4px; font-size: 10px; color: #aaa; }
        .location { position: absolute; top: 8px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 15px; border: 2px solid #ffd700; color: #ffd700; font-size: 12px; display: none; z-index: 10; }
        .location.show { display: block; }
        .joy-area { position: absolute; bottom: 20px; left: 20px; width: 110px; height: 110px; z-index: 100; display: none; }
        .joy-area.show { display: block; }
        .joy-base { width: 100%; height: 100%; background: rgba(50,50,70,0.8); border-radius: 50%; border: 3px solid rgba(255,215,0,0.4); position: relative; }
        .joy-stick { width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #777, #333); border-radius: 50%; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .btn-area { position: absolute; bottom: 20px; right: 12px; width: 120px; height: 120px; z-index: 100; display: none; }
        .btn-area.show { display: block; }
        .act-btn { position: absolute; width: 48px; height: 48px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 18px; color: #fff; }
        .act-btn:active { transform: scale(0.9); }
        .btn-a { background: #c0392b; right: 0; bottom: 0; }
        .btn-b { background: #2980b9; left: 0; bottom: 0; }
        .btn-x { background: #f39c12; right: 0; top: 0; }
        .btn-y { background: #27ae60; left: 0; top: 0; }
        .cd { position: absolute; inset: 0; background: rgba(0,0,0,0.7); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; }
        .cd.show { display: flex; }
        .menu-btn { position: absolute; top: 8px; right: 8px; width: 36px; height: 36px; background: rgba(0,0,0,0.8); border: 2px solid #ffd700; border-radius: 8px; display: none; align-items: center; justify-content: center; font-size: 18px; z-index: 100; }
        .menu-btn.show { display: flex; }
        .interact { position: absolute; bottom: 145px; left: 50%; transform: translateX(-50%); background: #8e44ad; padding: 8px 20px; border-radius: 15px; border: 2px solid #ffd700; color: #fff; font-size: 12px; display: none; z-index: 90; }
        .interact.show { display: block; }
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; padding: 15px; overflow-y: auto; }
        .screen.show { display: flex; }
        #startScreen { background: linear-gradient(135deg, #74ebd5, #ACB6E5); justify-content: flex-start; padding-top: 25px; }
        .title { font-size: 1.5em; background: linear-gradient(135deg, #f39c12, #e74c3c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; margin-bottom: 3px; }
        .subtitle { color: #34495e; font-size: 11px; margin-bottom: 12px; }
        .poke-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 300px; width: 100%; }
        .poke-card { background: rgba(255,255,255,0.9); border-radius: 10px; padding: 8px; text-align: center; border: 3px solid transparent; }
        .poke-card.sel { border-color: #f39c12; transform: translateY(-3px); }
        .poke-card img { width: 50px; height: 50px; }
        .poke-card .name { color: #2c3e50; font-weight: bold; font-size: 11px; }
        .poke-card .type { color: #e74c3c; font-size: 9px; }
        .start-btn { margin-top: 15px; padding: 10px 35px; background: linear-gradient(135deg, #f39c12, #e74c3c); color: #fff; border: none; border-radius: 20px; font-weight: bold; }
        .start-btn:disabled { background: #bdc3c7; }
        .popup { background: rgba(0,0,0,0.9); }
        .popup-box { background: linear-gradient(180deg, #2c3e50, #1a252f); border: 3px solid #ffd700; border-radius: 15px; padding: 20px; max-width: 320px; width: 90%; max-height: 75vh; overflow-y: auto; }
        .popup-title { color: #ffd700; font-size: 1.2em; text-align: center; margin-bottom: 12px; border-bottom: 1px solid #ffd700; padding-bottom: 8px; }
        .p-btn { width: 100%; padding: 10px; margin: 5px 0; border: none; border-radius: 8px; font-weight: bold; color: #fff; }
        .p-btn.green { background: #27ae60; }
        .p-btn.blue { background: #2980b9; }
        .p-btn.red { background: #c0392b; }
        .shop-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .shop-tab { flex: 1; padding: 6px; background: #34495e; border: none; border-radius: 6px; color: #aaa; font-size: 10px; }
        .shop-tab.active { background: #f39c12; color: #000; }
        .shop-list { max-height: 200px; overflow-y: auto; }
        .shop-item { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; margin-bottom: 6px; }
        .shop-item-icon { font-size: 24px; }
        .shop-item-info { flex: 1; }
        .shop-item-name { color: #fff; font-size: 11px; font-weight: bold; }
        .shop-item-desc { color: #aaa; font-size: 9px; }
        .shop-item-price { color: #ffd700; font-size: 10px; }
        .buy-btn { background: #27ae60; border: none; padding: 4px 10px; border-radius: 4px; color: #fff; font-size: 10px; }
        .buy-btn:disabled { background: #555; }
        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; }
        .inv-slot { aspect-ratio: 1; background: rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid transparent; position: relative; }
        .inv-slot.sel { border-color: #ffd700; }
        .inv-slot .cnt { position: absolute; bottom: 1px; right: 3px; font-size: 9px; color: #ffd700; }
        .inv-detail { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; display: none; }
        .inv-detail.show { display: block; }
        .inv-btns { display: flex; gap: 6px; margin-top: 8px; }
        .inv-btn { flex: 1; padding: 6px; border: none; border-radius: 4px; font-size: 10px; color: #fff; }
        .inv-btn.use { background: #27ae60; }
        .inv-btn.drop { background: #c0392b; }
        .equip-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 10px; }
        .equip-slot { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; text-align: center; }
        .equip-slot-label { color: #aaa; font-size: 9px; }
        .equip-slot-icon { font-size: 24px; margin: 4px 0; }
        .equip-slot-name { color: #fff; font-size: 10px; }
        .equip-stats { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; }
        .equip-stat { display: flex; justify-content: space-between; color: #aaa; font-size: 10px; margin: 2px 0; }
        .equip-stat span:last-child { color: #2ecc71; }
        .dialog { position: absolute; bottom: 70px; left: 8px; right: 8px; background: rgba(0,0,0,0.95); border: 3px solid #ffd700; border-radius: 12px; padding: 12px; display: none; z-index: 150; }
        .dialog.show { display: block; }
        .dialog-name { color: #ffd700; font-weight: bold; margin-bottom: 6px; font-size: 12px; }
        .dialog-text { color: #fff; font-size: 12px; line-height: 1.4; }
        .dialog-opts { margin-top: 10px; }
        .dialog-opt { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; color: #fff; border: none; width: 100%; text-align: left; font-size: 11px; margin-bottom: 5px; }
        .dialog-opt:hover { background: rgba(255,215,0,0.3); }
        .go-title { color: #c0392b; font-size: 1.5em; text-align: center; margin-bottom: 15px; }
        .go-stats { margin-bottom: 15px; }
        .go-stat { display: flex; justify-content: space-between; color: #fff; padding: 6px; background: rgba(255,255,255,0.1); border-radius: 4px; margin: 4px 0; font-size: 12px; }
        .go-stat span:last-child { color: #ffd700; }
    </style>
</head>
<body>
    <canvas id="c"></canvas>
    <div class="hud" id="hud">
        <div class="hud-box">
            <div class="hud-row">
                <img class="hud-icon" id="hudIcon">
                <div>
                    <div><span class="hud-name" id="hudName">-</span><span class="hud-lv">Lv.<span id="hudLv">1</span></span></div>
                    <div class="hud-row"><span style="color:#2ecc71;font-size:9px">HP</span><div class="bar"><div class="bar-fill bar-hp" id="hudHp"></div></div></div>
                    <div class="hud-row"><span style="color:#3498db;font-size:9px">MP</span><div class="bar"><div class="bar-fill bar-mp" id="hudMp"></div></div></div>
                    <div class="hud-row"><span style="color:#9b59b6;font-size:9px">EXP</span><div class="bar"><div class="bar-fill bar-exp" id="hudExp"></div></div></div>
                </div>
            </div>
            <div class="hud-stats"><span>âš”ï¸<span id="hudAtk">10</span></span><span>ğŸ›¡ï¸<span id="hudDef">5</span></span><span style="color:#ffd700">ğŸ’°<span id="hudGold">0</span></span></div>
        </div>
    </div>
    <div class="location" id="loc">ğŸ  íƒœì´ˆë§ˆì„</div>
    <div class="menu-btn" id="menuBtn">â˜°</div>
    <div class="joy-area" id="joyArea"><div class="joy-base" id="joyBase"><div class="joy-stick" id="joyStick"></div></div></div>
    <div class="btn-area" id="btnArea">
        <div class="act-btn btn-a" id="btnA">âš¡</div>
        <div class="act-btn btn-b" id="btnB">âœ¨<div class="cd" id="cdB"></div></div>
        <div class="act-btn btn-x" id="btnX">ğŸ’¥<div class="cd" id="cdX"></div></div>
        <div class="act-btn btn-y" id="btnY">ğŸ’¨<div class="cd" id="cdY"></div></div>
    </div>
    <div class="interact" id="interact">ğŸ’¬ ëŒ€í™”í•˜ê¸°</div>
    <div class="dialog" id="dialog">
        <div class="dialog-name" id="dName">???</div>
        <div class="dialog-text" id="dText"></div>
        <div class="dialog-opts" id="dOpts"></div>
    </div>
    <div class="screen show" id="startScreen">
        <div class="title">ğŸ® ì •ìš°ì˜ í¬ì¼“ëª¬ RPG</div>
        <div class="subtitle">Pokemon Adventure</div>
        <div class="poke-grid" id="pokeGrid"></div>
        <button class="start-btn" id="startBtn" disabled>í¬ì¼“ëª¬ì„ ì„ íƒí•˜ì„¸ìš”</button>
    </div>
    <div class="screen popup" id="menuScreen">
        <div class="popup-box">
            <div class="popup-title">â¸ï¸ ë©”ë‰´</div>
            <button class="p-btn green" onclick="closeMenu()">â–¶ï¸ ê³„ì†í•˜ê¸°</button>
            <button class="p-btn blue" onclick="openInv()">ğŸ’ ì¸ë²¤í† ë¦¬</button>
            <button class="p-btn blue" onclick="openEquip()">âš”ï¸ ì¥ë¹„</button>
            <button class="p-btn red" onclick="toTitle()">ğŸšª íƒ€ì´í‹€ë¡œ</button>
        </div>
    </div>
    <div class="screen popup" id="shopScreen">
        <div class="popup-box">
            <div class="popup-title">ğŸª í¬ì¼“ëª¬ ë§ˆíŠ¸</div>
            <div class="shop-tabs"><button class="shop-tab active" onclick="shopTab(0,this)">ì†Œë¹„</button><button class="shop-tab" onclick="shopTab(1,this)">ì¥ë¹„</button></div>
            <div class="shop-list" id="shopList"></div>
            <div style="text-align:center;color:#ffd700;margin:10px 0">ğŸ’° <span id="shopGold">0</span></div>
            <button class="p-btn blue" onclick="closeShop()">ë‹«ê¸°</button>
        </div>
    </div>
    <div class="screen popup" id="invScreen">
        <div class="popup-box">
            <div class="popup-title">ğŸ’ ì¸ë²¤í† ë¦¬</div>
            <div class="inv-grid" id="invGrid"></div>
            <div class="inv-detail" id="invDetail">
                <div id="invName" style="color:#ffd700;font-weight:bold;font-size:12px"></div>
                <div id="invDesc" style="color:#aaa;font-size:10px;margin:4px 0"></div>
                <div class="inv-btns"><button class="inv-btn use" id="invUse">ì‚¬ìš©</button><button class="inv-btn drop" onclick="dropItem()">ë²„ë¦¬ê¸°</button></div>
            </div>
            <button class="p-btn blue" onclick="closeInv()">ë‹«ê¸°</button>
        </div>
    </div>
    <div class="screen popup" id="equipScreen">
        <div class="popup-box">
            <div class="popup-title">âš”ï¸ ì¥ë¹„</div>
            <div class="equip-slots" id="equipSlots"></div>
            <div class="equip-stats" id="equipStats"></div>
            <button class="p-btn blue" onclick="closeEquip()">ë‹«ê¸°</button>
        </div>
    </div>
    <div class="screen popup" id="goScreen">
        <div class="popup-box">
            <div class="go-title">ğŸ’€ GAME OVER</div>
            <div class="go-stats"><div class="go-stat"><span>ë ˆë²¨</span><span id="goLv">1</span></div><div class="go-stat"><span>ì²˜ì¹˜</span><span id="goKills">0</span></div></div>
            <button class="p-btn green" onclick="respawn()">ğŸ  ë§ˆì„ ë¶€í™œ</button>
            <button class="p-btn red" onclick="toTitle()">ğŸšª íƒ€ì´í‹€ë¡œ</button>
        </div>
    </div>
<script>
const C = document.getElementById('c'), X = C.getContext('2d');
const resize = () => { C.width = innerWidth; C.height = innerHeight; };
resize(); onresize = resize;

const POKE = {
    pikachu: { id: 25, name: 'í”¼ì¹´ì¸„', type: 'ì „ê¸°', hp: 100, mp: 50, atk: 15, def: 8, spd: 5, color: '#f1c40f' },
    charmander: { id: 4, name: 'íŒŒì´ë¦¬', type: 'ë¶ˆê½ƒ', hp: 90, mp: 60, atk: 18, def: 6, spd: 4.5, color: '#e74c3c' },
    squirtle: { id: 7, name: 'ê¼¬ë¶€ê¸°', type: 'ë¬¼', hp: 130, mp: 40, atk: 12, def: 12, spd: 3.8, color: '#3498db' },
    bulbasaur: { id: 1, name: 'ì´ìƒí•´ì”¨', type: 'í’€', hp: 110, mp: 55, atk: 14, def: 10, spd: 4, color: '#2ecc71' },
    eevee: { id: 133, name: 'ì´ë¸Œì´', type: 'ë…¸ë§', hp: 100, mp: 45, atk: 14, def: 9, spd: 5.5, color: '#c8a87c' },
    gengar: { id: 94, name: 'íŒ¬í…€', type: 'ê³ ìŠ¤íŠ¸', hp: 85, mp: 70, atk: 20, def: 5, spd: 6, color: '#9b59b6' }
};
const ENEMY = {
    rattata: { id: 19, name: 'ê¼¬ë ›', hp: 35, atk: 6, def: 2, spd: 2, exp: 12, gold: 5 },
    pidgey: { id: 16, name: 'êµ¬êµ¬', hp: 40, atk: 7, def: 3, spd: 2.5, exp: 15, gold: 7 },
    zubat: { id: 41, name: 'ì£¼ë±ƒ', hp: 50, atk: 9, def: 3, spd: 3, exp: 20, gold: 10 },
    geodude: { id: 74, name: 'ê¼¬ë§ˆëŒ', hp: 70, atk: 12, def: 10, spd: 1.2, exp: 25, gold: 15 }
};
const ITEMS = {
    potion: { name: 'íšŒë³µì•½', icon: 'ğŸ§´', desc: 'HP 50 íšŒë³µ', price: 50, type: 'use', eff: { hp: 50 } },
    superPotion: { name: 'ê³ ê¸‰íšŒë³µì•½', icon: 'ğŸ’Š', desc: 'HP 100 íšŒë³µ', price: 120, type: 'use', eff: { hp: 100 } },
    ether: { name: 'ì´ë”', icon: 'ğŸ’§', desc: 'MP 30 íšŒë³µ', price: 80, type: 'use', eff: { mp: 30 } },
    sword1: { name: 'ë‚ ì¹´ë¡œìš´ë°œí†±', icon: 'ğŸ—¡ï¸', desc: 'ê³µê²©ë ¥ +5', price: 200, type: 'weapon', stat: { atk: 5 } },
    sword2: { name: 'ê°•ì² ë°œí†±', icon: 'âš”ï¸', desc: 'ê³µê²©ë ¥ +12', price: 500, type: 'weapon', stat: { atk: 12 } },
    armor1: { name: 'ê°€ì£½ì¡°ë¼', icon: 'ğŸ¥‹', desc: 'ë°©ì–´ë ¥ +3', price: 150, type: 'armor', stat: { def: 3 } },
    armor2: { name: 'ê°•ì² ê°‘ì˜·', icon: 'ğŸ›¡ï¸', desc: 'ë°©ì–´ë ¥ +8', price: 400, type: 'armor', stat: { def: 8 } }
};
const MAPS = {
    town: { name: 'íƒœì´ˆë§ˆì„', w: 800, h: 600, colors: ['#90d080', '#80c070'], enemies: false, npcs: [
        { id: 'nurse', x: 400, y: 180, icon: 'ğŸ‘©â€âš•ï¸', name: 'ê°„í˜¸ì‚¬ ë‹¤ì†”', type: 'heal' },
        { id: 'shop', x: 200, y: 280, icon: 'ğŸ§‘â€ğŸ’¼', name: 'ìƒì ì£¼ì¸ í˜¸ì² ', type: 'shop' },
        { id: 'boyoung', x: 600, y: 350, icon: 'ğŸ‘©', name: 'ë³´ì˜ì—„ë§ˆ', type: 'boyoung' }
    ], buildings: [{ x: 350, y: 80, w: 100, h: 80, color: '#e74c3c', icon: 'ğŸ¥' }, { x: 150, y: 200, w: 100, h: 80, color: '#3498db', icon: 'ğŸª' }],
    portals: [{ x: 750, y: 250, w: 50, h: 100, to: 'route1', tx: 50, ty: 300, label: '1ë²ˆë„ë¡œ â†’' }] },
    route1: { name: '1ë²ˆë„ë¡œ', w: 1200, h: 800, colors: ['#88c070', '#78b060'], enemies: true, types: ['rattata', 'pidgey'], max: 8, rate: 3000, npcs: [], buildings: [], trees: 15,
    portals: [{ x: 0, y: 250, w: 50, h: 100, to: 'town', tx: 700, ty: 300, label: 'â† íƒœì´ˆë§ˆì„' }, { x: 1150, y: 350, w: 50, h: 100, to: 'route2', tx: 50, ty: 400, label: '2ë²ˆë„ë¡œ â†’' }] },
    route2: { name: '2ë²ˆë„ë¡œ', w: 1500, h: 1000, colors: ['#80a860', '#70984f'], enemies: true, types: ['pidgey', 'zubat', 'geodude'], max: 12, rate: 2500, npcs: [], buildings: [], trees: 25, rocks: 10,
    portals: [{ x: 0, y: 350, w: 50, h: 100, to: 'route1', tx: 1100, ty: 400, label: 'â† 1ë²ˆë„ë¡œ' }] }
};

let state = 'title', map = 'town', P = null, enemies = [], projs = [], parts = [], npcs = [], obs = [], portals = [], drops = [];
let cam = { x: 0, y: 0 }, input = { mx: 0, my: 0, a: 0, b: 0, x: 0, y: 0 }, joy = { on: 0, id: null, cx: 0, cy: 0 };
let cd = { a: 0, b: 0, x: 0, y: 0 }, inv = [], equip = { weapon: null, armor: null }, kills = 0, lt = 0, spawnT = 0;
let nearNpc = null, nearPortal = null, selPoke = null, selInv = -1, shopMode = 0;
const imgs = {};

const spr = (id, back) => `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon${back ? '/back' : ''}/${id}.png`;
const dist = (a, b) => Math.hypot(a.x - b.x, a.y - b.y);
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const rand = (a, b) => Math.random() * (b - a) + a;

async function loadImg(src) {
    if (imgs[src]) return imgs[src];
    return new Promise(r => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => { imgs[src] = img; r(img); };
        img.onerror = () => r(null);
        img.src = src;
    });
}

async function preload() {
    const urls = [];
    Object.values(POKE).forEach(p => { urls.push(spr(p.id), spr(p.id, 1)); });
    Object.values(ENEMY).forEach(e => { urls.push(spr(e.id), spr(e.id, 1)); });
    await Promise.all(urls.map(loadImg));
}

function initSelect() {
    const g = document.getElementById('pokeGrid');
    g.innerHTML = '';
    Object.entries(POKE).forEach(([k, p]) => {
        const d = document.createElement('div');
        d.className = 'poke-card';
        d.innerHTML = `<img src="${spr(p.id)}"><div class="name">${p.name}</div><div class="type">${p.type}</div>`;
        d.onclick = () => {
            document.querySelectorAll('.poke-card').forEach(c => c.classList.remove('sel'));
            d.classList.add('sel');
            selPoke = k;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'ğŸ® ëª¨í—˜ ì‹œì‘!';
        };
        g.appendChild(d);
    });
}

function startGame() {
    if (!selPoke) return;
    const d = POKE[selPoke];
    P = { x: 400, y: 400, w: 48, h: 48, hp: d.hp, maxHp: d.hp, mp: d.mp, maxMp: d.mp, atk: d.atk, def: d.def, spd: d.spd,
        baseAtk: d.atk, baseDef: d.def, baseSpd: d.spd, baseHp: d.hp, lv: 1, exp: 0, expNext: 100, gold: 100,
        pid: d.id, name: d.name, color: d.color, dir: 'down', inv: 0, dash: 0, dashT: 0 };
    inv = [{ id: 'potion', n: 3 }];
    equip = { weapon: null, armor: null };
    kills = 0;
    loadMap('town');
    state = 'play';
    document.getElementById('startScreen').classList.remove('show');
    showUI(1);
    updateHUD();
    lt = performance.now();
    requestAnimationFrame(loop);
}

function showUI(s) {
    ['hud', 'loc', 'joyArea', 'btnArea', 'menuBtn'].forEach(id => document.getElementById(id).classList.toggle('show', s));
}

function loadMap(m) {
    map = m;
    const M = MAPS[m];
    document.getElementById('loc').textContent = (M.enemies ? 'âš”ï¸ ' : 'ğŸ  ') + M.name;
    enemies = []; projs = []; parts = []; npcs = []; obs = []; portals = []; drops = []; spawnT = 0;
    if (M.npcs) M.npcs.forEach(n => npcs.push({ ...n, w: 40, h: 40 }));
    if (M.buildings) M.buildings.forEach(b => obs.push({ ...b, type: 'bld' }));
    if (M.trees) for (let i = 0; i < M.trees; i++) obs.push({ x: rand(50, M.w - 50), y: rand(50, M.h - 50), w: 40, h: 40, type: 'tree' });
    if (M.rocks) for (let i = 0; i < M.rocks; i++) obs.push({ x: rand(50, M.w - 50), y: rand(50, M.h - 50), w: 35, h: 35, type: 'rock' });
    if (M.portals) portals = M.portals.map(p => ({ ...p }));
}

function loop(t) {
    if (state !== 'play') return;
    const dt = Math.min((t - lt) / 1000, 0.1);
    lt = t;
    update(dt);
    render();
    requestAnimationFrame(loop);
}

function update(dt) {
    const M = MAPS[map];
    updatePlayer(dt, M);
    updateEnemies(dt);
    updateProjs(dt, M);
    updateParts(dt);
    if (M.enemies) spawnEnemies(dt, M);
    checkInteract();
    updateCam(M);
    updateCD();
    updateHUD();
}

function updatePlayer(dt, M) {
    if (P.dash) { P.dashT -= dt; if (P.dashT <= 0) P.dash = 0; }
    
    let mx = input.mx, my = input.my;
    if (mx || my) {
        const len = Math.hypot(mx, my);
        if (len > 0) { mx /= len; my /= len; }
        
        // ë°©í–¥ ì„¤ì • - ìˆ˜ì •ë¨
        if (Math.abs(mx) > Math.abs(my)) {
            P.dir = mx < 0 ? 'left' : 'right';
        } else if (Math.abs(my) > 0.1) {
            P.dir = my < 0 ? 'up' : 'down';
        }
        
        const spd = P.dash ? P.spd * 3 : P.spd;
        const nx = P.x + mx * spd * dt * 60;
        const ny = P.y + my * spd * dt * 60;
        
        let ok = 1;
        obs.forEach(o => {
            if (nx > o.x - P.w/2 && nx < o.x + o.w + P.w/2 && ny > o.y - P.h/2 && ny < o.y + o.h + P.h/2) ok = 0;
        });
        if (ok) {
            P.x = clamp(nx, P.w/2, M.w - P.w/2);
            P.y = clamp(ny, P.h/2, M.h - P.h/2);
        }
    }
    
    if (P.inv > 0) P.inv -= dt * 60;
    Object.keys(cd).forEach(k => { if (cd[k] > 0) cd[k] -= dt * 60; });
    
    if (input.a && cd.a <= 0 && M.enemies) { fireAtk(); cd.a = 15; }
    if (input.b && cd.b <= 0 && P.mp >= 10 && M.enemies) { fireSkill(); cd.b = 180; P.mp -= 10; }
    if (input.x && cd.x <= 0 && P.mp >= 25 && M.enemies) { fireSpecial(); cd.x = 300; P.mp -= 25; }
    if (input.y && cd.y <= 0 && !P.dash) { P.dash = 1; P.dashT = 0.15; P.inv = Math.max(P.inv, 15); cd.y = 90; spawnParts(P.x, P.y, P.color, 8); }
    
    drops = drops.filter(d => {
        if (dist(P, d) < 40) { addInv(d.id); spawnParts(d.x, d.y, '#ffd700', 5); return 0; }
        return 1;
    });
}

function fireAtk() {
    const dirs = { up: { x: 0, y: -1 }, down: { x: 0, y: 1 }, left: { x: -1, y: 0 }, right: { x: 1, y: 0 } };
    const d = dirs[P.dir];
    projs.push({ x: P.x + d.x * 25, y: P.y + d.y * 25, vx: d.x * 10, vy: d.y * 10, dmg: P.atk, sz: 8, color: P.color, own: 'p', life: 50 });
    spawnParts(P.x + d.x * 20, P.y + d.y * 20, P.color, 3);
}

function fireSkill() {
    for (let i = 0; i < 8; i++) {
        const a = (i / 8) * Math.PI * 2;
        projs.push({ x: P.x, y: P.y, vx: Math.cos(a) * 7, vy: Math.sin(a) * 7, dmg: Math.floor(P.atk * 1.5), sz: 10, color: '#3498db', own: 'p', life: 50 });
    }
    spawnParts(P.x, P.y, '#3498db', 10);
}

function fireSpecial() {
    const r = 120;
    enemies.forEach(e => { if (dist(e, P) < r) dmgEnemy(e, Math.floor(P.atk * 3)); });
    for (let i = 0; i < 20; i++) {
        const a = (i / 20) * Math.PI * 2;
        parts.push({ x: P.x + Math.cos(a) * rand(20, r), y: P.y + Math.sin(a) * rand(20, r), vx: Math.cos(a) * 3, vy: Math.sin(a) * 3, life: 30, color: '#ffd700', sz: 6 });
    }
}

function spawnEnemies(dt, M) {
    spawnT += dt * 1000;
    if (spawnT > M.rate && enemies.length < M.max) {
        spawnT = 0;
        const type = M.types[Math.floor(Math.random() * M.types.length)];
        const d = ENEMY[type];
        const mult = 1 + P.lv * 0.1;
        let x, y;
        do { x = rand(50, M.w - 50); y = rand(50, M.h - 50); } while (dist({ x, y }, P) < 200);
        enemies.push({ x, y, w: 40, h: 40, hp: Math.floor(d.hp * mult), maxHp: Math.floor(d.hp * mult), atk: Math.floor(d.atk * mult), def: d.def, spd: d.spd, exp: d.exp, gold: d.gold, pid: d.id, name: d.name, dir: 'down', atkCd: 0, hit: 0 });
    }
}

function updateEnemies(dt) {
    enemies.forEach(e => {
        if (e.hit > 0) e.hit -= dt * 60;
        const dx = P.x - e.x, dy = P.y - e.y, d = Math.hypot(dx, dy);
        if (d > 30) {
            e.x += (dx / d) * e.spd * dt * 60;
            e.y += (dy / d) * e.spd * dt * 60;
            if (Math.abs(dx) > Math.abs(dy)) e.dir = dx < 0 ? 'left' : 'right';
            else e.dir = dy < 0 ? 'up' : 'down';
        }
        if (d < 35 && P.inv <= 0 && e.atkCd <= 0) {
            const dmg = Math.max(1, e.atk - P.def);
            P.hp -= dmg;
            P.inv = 45;
            e.atkCd = 60;
            P.x -= (dx / d) * 20;
            P.y -= (dy / d) * 20;
            spawnParts(P.x, P.y, '#e74c3c', 6);
            if (P.hp <= 0) gameOver();
        }
        if (e.atkCd > 0) e.atkCd -= dt * 60;
    });
}

function dmgEnemy(e, dmg) {
    const d = Math.max(1, dmg - e.def);
    e.hp -= d;
    e.hit = 10;
    if (e.hp <= 0) {
        kills++;
        gainExp(e.exp);
        P.gold += e.gold;
        if (Math.random() < 0.2) drops.push({ x: e.x, y: e.y, id: ['potion', 'ether'][Math.floor(Math.random() * 2)] });
        spawnParts(e.x, e.y, '#ffd700', 12);
        enemies = enemies.filter(en => en !== e);
    }
}

function gainExp(n) {
    P.exp += n;
    while (P.exp >= P.expNext) {
        P.exp -= P.expNext;
        P.lv++;
        P.expNext = Math.floor(100 * Math.pow(1.25, P.lv - 1));
        P.baseHp += 10; P.baseAtk += 2; P.baseDef += 1;
        recalc();
        P.hp = P.maxHp; P.mp = P.maxMp;
        spawnParts(P.x, P.y, '#ffd700', 20);
    }
}

function recalc() {
    P.maxHp = P.baseHp;
    P.atk = P.baseAtk + (equip.weapon?.stat?.atk || 0);
    P.def = P.baseDef + (equip.armor?.stat?.def || 0);
}

function updateProjs(dt, M) {
    projs = projs.filter(p => {
        p.x += p.vx * dt * 60;
        p.y += p.vy * dt * 60;
        p.life -= dt * 60;
        if (p.x < 0 || p.x > M.w || p.y < 0 || p.y > M.h || p.life <= 0) return 0;
        if (p.own === 'p') {
            for (let e of enemies) {
                if (dist(p, e) < e.w / 2 + p.sz) { dmgEnemy(e, p.dmg); spawnParts(p.x, p.y, '#fff', 3); return 0; }
            }
        } else {
            if (P.inv <= 0 && dist(p, P) < P.w / 2 + p.sz) {
                const dmg = Math.max(1, p.dmg - P.def);
                P.hp -= dmg; P.inv = 45;
                spawnParts(P.x, P.y, '#e74c3c', 5);
                if (P.hp <= 0) gameOver();
                return 0;
            }
        }
        return 1;
    });
}

function spawnParts(x, y, color, n) {
    for (let i = 0; i < n; i++) parts.push({ x, y, vx: rand(-4, 4), vy: rand(-4, 4), life: rand(15, 25), color, sz: rand(3, 6) });
}

function updateParts(dt) {
    parts = parts.filter(p => { p.x += p.vx * dt * 60; p.y += p.vy * dt * 60; p.vx *= 0.95; p.vy *= 0.95; p.life -= dt * 60; return p.life > 0; });
}

function checkInteract() {
    nearNpc = null; nearPortal = null;
    npcs.forEach(n => { if (dist(P, n) < 50) nearNpc = n; });
    portals.forEach(p => { if (P.x > p.x && P.x < p.x + p.w && P.y > p.y && P.y < p.y + p.h) nearPortal = p; });
    const btn = document.getElementById('interact');
    if (nearNpc) { btn.textContent = `ğŸ’¬ ${nearNpc.name}`; btn.classList.add('show'); }
    else if (nearPortal) { btn.textContent = `ğŸšª ${nearPortal.label}`; btn.classList.add('show'); }
    else btn.classList.remove('show');
}

function interact() {
    if (nearNpc) startDialog(nearNpc);
    else if (nearPortal) { P.x = nearPortal.tx; P.y = nearPortal.ty; loadMap(nearPortal.to); }
}

function startDialog(n) {
    state = 'dialog';
    const d = document.getElementById('dialog');
    const name = document.getElementById('dName');
    const text = document.getElementById('dText');
    const opts = document.getElementById('dOpts');
    name.textContent = n.name;
    opts.innerHTML = '';
    if (n.type === 'heal') {
        text.textContent = 'ì–´ì„œì˜¤ì„¸ìš”! í¬ì¼“ëª¬ì„ ì¹˜ë£Œí•´ ë“œë¦´ê¹Œìš”?';
        opts.innerHTML = '<button class="dialog-opt" onclick="healP()">âœ… ë„¤</button><button class="dialog-opt" onclick="closeDialog()">âŒ ì•„ë‹ˆìš”</button>';
    } else if (n.type === 'shop') {
        text.textContent = 'í¬ì¼“ëª¬ ë§ˆíŠ¸ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!';
        opts.innerHTML = '<button class="dialog-opt" onclick="closeDialog();openShop()">ğŸ›’ ì‡¼í•‘</button><button class="dialog-opt" onclick="closeDialog()">ğŸ‘‹ ë‚˜ê°€ê¸°</button>';
    } else if (n.type === 'boyoung') {
        text.textContent = 'ì •ìš° ì—‰ë©ì´ ëŒ€!!';
        opts.innerHTML = '<button class="dialog-opt" onclick="boyoungStep2()">1ëŒ€</button><button class="dialog-opt" onclick="boyoungStep2()">2ëŒ€</button><button class="dialog-opt" onclick="boyoungStep2()">15ëŒ€</button>';
    }
    d.classList.add('show');
}

function healP() {
    P.hp = P.maxHp; P.mp = P.maxMp;
    document.getElementById('dText').textContent = 'ì¹˜ë£Œ ì™„ë£Œ! ğŸ’–';
    document.getElementById('dOpts').innerHTML = '<button class="dialog-opt" onclick="closeDialog()">ê°ì‚¬í•©ë‹ˆë‹¤!</button>';
}

function boyoungStep2() {
    document.getElementById('dText').textContent = 'ë­˜ë¡œ ë§ì„ë˜?';
    document.getElementById('dOpts').innerHTML = '<button class="dialog-opt" onclick="boyoungHit()">ì£¼ê±±</button><button class="dialog-opt" onclick="boyoungHit()">ì•¼êµ¬ë°©ë§ì´</button><button class="dialog-opt" onclick="boyoungHit()">íšŒì´ˆë¦¬</button>';
}

function boyoungHit() {
    P.hp = Math.floor(P.hp / 2);
    document.getElementById('dText').textContent = 'ì•„ì•¼!! ğŸ’¥';
    document.getElementById('dOpts').innerHTML = '<button class="dialog-opt" onclick="closeDialog()">ğŸ˜­ í‘í‘...</button>';
    updateHUD();
}

function closeDialog() {
    document.getElementById('dialog').classList.remove('show');
    state = 'play';
    lt = performance.now();
    requestAnimationFrame(loop);
}

function openShop() {
    document.getElementById('shopScreen').classList.add('show');
    document.getElementById('shopGold').textContent = P.gold;
    shopMode = 0;
    renderShop();
    state = 'shop';
}

function closeShop() {
    document.getElementById('shopScreen').classList.remove('show');
    state = 'play';
    lt = performance.now();
    requestAnimationFrame(loop);
}

function shopTab(m, el) {
    shopMode = m;
    document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderShop();
}

function renderShop() {
    const list = document.getElementById('shopList');
    list.innerHTML = '';
    const items = shopMode === 0 ? ['potion', 'superPotion', 'ether'] : ['sword1', 'sword2', 'armor1', 'armor2'];
    items.forEach(id => {
        const it = ITEMS[id];
        const d = document.createElement('div');
        d.className = 'shop-item';
        d.innerHTML = `<div class="shop-item-icon">${it.icon}</div><div class="shop-item-info"><div class="shop-item-name">${it.name}</div><div class="shop-item-desc">${it.desc}</div></div><div><div class="shop-item-price">ğŸ’° ${it.price}</div><button class="buy-btn" onclick="buyItem('${id}')" ${P.gold < it.price ? 'disabled' : ''}>êµ¬ë§¤</button></div>`;
        list.appendChild(d);
    });
}

function buyItem(id) {
    const it = ITEMS[id];
    if (P.gold < it.price) return;
    P.gold -= it.price;
    addInv(id);
    document.getElementById('shopGold').textContent = P.gold;
    renderShop();
}

function addInv(id) {
    const ex = inv.find(i => i.id === id);
    if (ex) ex.n++; else inv.push({ id, n: 1 });
}

function openInv() {
    closeMenu();
    document.getElementById('invScreen').classList.add('show');
    selInv = -1;
    renderInv();
    state = 'inv';
}

function closeInv() {
    document.getElementById('invScreen').classList.remove('show');
    state = 'play';
    lt = performance.now();
    requestAnimationFrame(loop);
}

function renderInv() {
    const g = document.getElementById('invGrid');
    g.innerHTML = '';
    for (let i = 0; i < 12; i++) {
        const s = document.createElement('div');
        s.className = 'inv-slot' + (i === selInv ? ' sel' : '');
        if (inv[i]) { const it = ITEMS[inv[i].id]; s.innerHTML = `${it?.icon || '?'}<span class="cnt">${inv[i].n}</span>`; }
        s.onclick = () => { selInv = i; renderInv(); };
        g.appendChild(s);
    }
    const det = document.getElementById('invDetail');
    if (selInv >= 0 && inv[selInv]) {
        const it = ITEMS[inv[selInv].id];
        det.classList.add('show');
        document.getElementById('invName').textContent = it.name;
        document.getElementById('invDesc').textContent = it.desc;
        const btn = document.getElementById('invUse');
        if (it.type === 'use') { btn.textContent = 'ì‚¬ìš©'; btn.onclick = () => useItem(selInv); }
        else if (it.type === 'weapon' || it.type === 'armor') { btn.textContent = 'ì¥ì°©'; btn.onclick = () => equipItem(selInv); }
        else { btn.textContent = '-'; btn.onclick = null; }
    } else det.classList.remove('show');
}

function useItem(i) {
    const iv = inv[i]; if (!iv) return;
    const it = ITEMS[iv.id];
    if (it.eff?.hp) P.hp = Math.min(P.maxHp, P.hp + it.eff.hp);
    if (it.eff?.mp) P.mp = Math.min(P.maxMp, P.mp + it.eff.mp);
    iv.n--; if (iv.n <= 0) inv.splice(i, 1);
    selInv = -1; renderInv(); updateHUD();
}

function equipItem(i) {
    const iv = inv[i]; if (!iv) return;
    const it = ITEMS[iv.id];
    const slot = it.type === 'weapon' ? 'weapon' : 'armor';
    if (equip[slot]) addInv(equip[slot].id);
    equip[slot] = { ...it, id: iv.id };
    iv.n--; if (iv.n <= 0) inv.splice(i, 1);
    recalc(); selInv = -1; renderInv(); updateHUD();
}

function dropItem() {
    if (selInv < 0 || !inv[selInv]) return;
    inv[selInv].n--; if (inv[selInv].n <= 0) inv.splice(selInv, 1);
    selInv = -1; renderInv();
}

function openEquip() {
    closeMenu();
    document.getElementById('equipScreen').classList.add('show');
    renderEquip();
    state = 'equip';
}

function closeEquip() {
    document.getElementById('equipScreen').classList.remove('show');
    state = 'play';
    lt = performance.now();
    requestAnimationFrame(loop);
}

function renderEquip() {
    const s = document.getElementById('equipSlots');
    s.innerHTML = `<div class="equip-slot"><div class="equip-slot-label">ë¬´ê¸°</div><div class="equip-slot-icon">${equip.weapon?.icon || 'â–'}</div><div class="equip-slot-name">${equip.weapon?.name || 'ì—†ìŒ'}</div></div>
    <div class="equip-slot"><div class="equip-slot-label">ë°©ì–´êµ¬</div><div class="equip-slot-icon">${equip.armor?.icon || 'â–'}</div><div class="equip-slot-name">${equip.armor?.name || 'ì—†ìŒ'}</div></div>`;
    const st = document.getElementById('equipStats');
    st.innerHTML = `<div class="equip-stat"><span>ê³µê²©ë ¥</span><span>${P.baseAtk} + ${equip.weapon?.stat?.atk || 0}</span></div>
    <div class="equip-stat"><span>ë°©ì–´ë ¥</span><span>${P.baseDef} + ${equip.armor?.stat?.def || 0}</span></div>`;
}

function openMenu() { document.getElementById('menuScreen').classList.add('show'); state = 'menu'; }
function closeMenu() { document.getElementById('menuScreen').classList.remove('show'); state = 'play'; lt = performance.now(); requestAnimationFrame(loop); }
function toTitle() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('show'));
    document.getElementById('startScreen').classList.add('show');
    showUI(0);
    state = 'title';
    selPoke = null;
    document.querySelectorAll('.poke-card').forEach(c => c.classList.remove('sel'));
    document.getElementById('startBtn').disabled = true;
    document.getElementById('startBtn').textContent = 'í¬ì¼“ëª¬ì„ ì„ íƒí•˜ì„¸ìš”';
}

function gameOver() {
    state = 'gameover';
    document.getElementById('goLv').textContent = P.lv;
    document.getElementById('goKills').textContent = kills;
    document.getElementById('goScreen').classList.add('show');
}

function respawn() {
    document.getElementById('goScreen').classList.remove('show');
    P.hp = Math.floor(P.maxHp / 2); P.mp = Math.floor(P.maxMp / 2);
    P.gold = Math.floor(P.gold / 2);
    P.x = 400; P.y = 400;
    loadMap('town');
    state = 'play';
    lt = performance.now();
    requestAnimationFrame(loop);
}

function updateCam(M) {
    const tx = P.x - C.width / 2, ty = P.y - C.height / 2;
    cam.x += (tx - cam.x) * 0.1;
    cam.y += (ty - cam.y) * 0.1;
    cam.x = clamp(cam.x, 0, Math.max(0, M.w - C.width));
    cam.y = clamp(cam.y, 0, Math.max(0, M.h - C.height));
}

function updateHUD() {
    document.getElementById('hudIcon').src = spr(P.pid);
    document.getElementById('hudName').textContent = P.name;
    document.getElementById('hudLv').textContent = P.lv;
    document.getElementById('hudHp').style.width = (P.hp / P.maxHp * 100) + '%';
    document.getElementById('hudMp').style.width = (P.mp / P.maxMp * 100) + '%';
    document.getElementById('hudExp').style.width = (P.exp / P.expNext * 100) + '%';
    document.getElementById('hudAtk').textContent = P.atk;
    document.getElementById('hudDef').textContent = P.def;
    document.getElementById('hudGold').textContent = P.gold;
}

function updateCD() {
    const show = (id, v) => { const e = document.getElementById(id); if (v > 0) { e.classList.add('show'); e.textContent = Math.ceil(v / 60); } else e.classList.remove('show'); };
    show('cdB', cd.b);
    show('cdX', cd.x);
    show('cdY', cd.y);
}

function render() {
    const M = MAPS[map];
    X.clearRect(0, 0, C.width, C.height);
    X.save();
    X.translate(-cam.x, -cam.y);
    
    // ë°°ê²½
    const ts = 32, sx = Math.floor(cam.x / ts) * ts, sy = Math.floor(cam.y / ts) * ts;
    for (let x = sx; x < sx + C.width + ts * 2 && x < M.w; x += ts)
        for (let y = sy; y < sy + C.height + ts * 2 && y < M.h; y += ts) {
            X.fillStyle = M.colors[(Math.floor(x/ts) + Math.floor(y/ts)) % 2];
            X.fillRect(x, y, ts, ts);
        }
    
    // í¬íƒˆ
    portals.forEach(p => {
        X.fillStyle = 'rgba(147, 112, 219, 0.5)';
        X.fillRect(p.x, p.y, p.w, p.h);
        X.fillStyle = '#fff'; X.font = '9px sans-serif'; X.textAlign = 'center';
        X.fillText(p.label, p.x + p.w/2, p.y - 5);
    });
    
    // ê±´ë¬¼
    obs.filter(o => o.type === 'bld').forEach(b => {
        X.fillStyle = b.color; X.fillRect(b.x, b.y, b.w, b.h);
        X.fillStyle = '#fff'; X.font = '20px sans-serif'; X.textAlign = 'center';
        X.fillText(b.icon, b.x + b.w/2, b.y + b.h/2 + 7);
    });
    
    // ë‚˜ë¬´/ë°”ìœ„
    obs.filter(o => o.type === 'tree' || o.type === 'rock').forEach(o => {
        X.font = '28px sans-serif'; X.textAlign = 'center';
        X.fillText(o.type === 'tree' ? 'ğŸŒ²' : 'ğŸª¨', o.x + o.w/2, o.y + o.h/2 + 10);
    });
    
    // ë“œë¡­
    drops.forEach(d => {
        const it = ITEMS[d.id];
        X.font = '18px sans-serif'; X.textAlign = 'center';
        X.fillText(it?.icon || '?', d.x, d.y + Math.sin(Date.now()/200) * 3);
    });
    
    // NPC
    npcs.forEach(n => { X.font = '28px sans-serif'; X.textAlign = 'center'; X.fillText(n.icon, n.x, n.y + 10); });
    
    // íŒŒí‹°í´
    parts.forEach(p => {
        X.globalAlpha = p.life / 25;
        X.fillStyle = p.color;
        X.beginPath(); X.arc(p.x, p.y, p.sz, 0, Math.PI * 2); X.fill();
    });
    X.globalAlpha = 1;
    
    // íˆ¬ì‚¬ì²´
    projs.forEach(p => {
        X.fillStyle = p.color; X.shadowColor = p.color; X.shadowBlur = 10;
        X.beginPath(); X.arc(p.x, p.y, p.sz, 0, Math.PI * 2); X.fill();
        X.shadowBlur = 0;
    });
    
    // ì 
    enemies.forEach(e => drawChar(e, 1));
    
    // í”Œë ˆì´ì–´
    if (P.inv <= 0 || Math.floor(Date.now()/80) % 2 === 0) drawChar(P, 0);
    
    X.restore();
}

function drawChar(c, isEnemy) {
    const back = c.dir === 'up';
    const img = imgs[spr(c.pid, back)];
    
    X.fillStyle = 'rgba(0,0,0,0.2)';
    X.beginPath(); X.ellipse(c.x, c.y + c.h/2, c.w/3, 8, 0, 0, Math.PI * 2); X.fill();
    
    if (img) {
        X.save();
        if (c.hit > 0) X.filter = 'brightness(2)';
        if (c.dir === 'right') {
            X.translate(c.x, c.y);
            X.scale(-1, 1);
            X.drawImage(img, -c.w/2, -c.h/2, c.w, c.h);
        } else {
            X.drawImage(img, c.x - c.w/2, c.y - c.h/2, c.w, c.h);
        }
        X.restore();
    }
    
    if (isEnemy) {
        const pct = c.hp / c.maxHp;
        X.fillStyle = '#333'; X.fillRect(c.x - 18, c.y - c.h/2 - 8, 36, 4);
        X.fillStyle = pct > 0.3 ? '#2ecc71' : '#e74c3c';
        X.fillRect(c.x - 18, c.y - c.h/2 - 8, 36 * pct, 4);
    }
}

// ì…ë ¥
const joyArea = document.getElementById('joyArea');
const joyStick = document.getElementById('joyStick');
const maxD = 30;

function joyStart(e) {
    e.preventDefault();
    const t = e.touches ? e.touches[0] : e;
    const r = joyArea.getBoundingClientRect();
    joy.on = 1;
    joy.cx = r.left + r.width / 2;
    joy.cy = r.top + r.height / 2;
    if (e.touches) joy.id = t.identifier;
    joyMove(e);
}

function joyMove(e) {
    if (!joy.on) return;
    e.preventDefault();
    let t;
    if (e.touches) { for (let x of e.touches) if (x.identifier === joy.id) { t = x; break; } if (!t) return; }
    else t = e;
    const dx = t.clientX - joy.cx, dy = t.clientY - joy.cy;
    const d = Math.hypot(dx, dy), cd = Math.min(d, maxD), a = Math.atan2(dy, dx);
    const sx = Math.cos(a) * cd, sy = Math.sin(a) * cd;
    joyStick.style.left = `calc(50% + ${sx}px)`;
    joyStick.style.top = `calc(50% + ${sy}px)`;
    input.mx = cd > 5 ? sx / maxD : 0;
    input.my = cd > 5 ? sy / maxD : 0;
}

function joyEnd(e) {
    if (e.touches && e.touches.length > 0) { for (let t of e.touches) if (t.identifier === joy.id) return; }
    joy.on = 0;
    joyStick.style.left = '50%';
    joyStick.style.top = '50%';
    input.mx = 0;
    input.my = 0;
}

joyArea.addEventListener('touchstart', joyStart, { passive: false });
joyArea.addEventListener('touchmove', joyMove, { passive: false });
joyArea.addEventListener('touchend', joyEnd);
joyArea.addEventListener('touchcancel', joyEnd);
joyArea.addEventListener('mousedown', joyStart);
document.addEventListener('mousemove', e => { if (joy.on) joyMove(e); });
document.addEventListener('mouseup', joyEnd);

function btn(id, k) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', e => { e.preventDefault(); input[k] = 1; }, { passive: false });
    el.addEventListener('touchend', e => { e.preventDefault(); input[k] = 0; });
    el.addEventListener('mousedown', () => input[k] = 1);
    el.addEventListener('mouseup', () => input[k] = 0);
}
btn('btnA', 'a'); btn('btnB', 'b'); btn('btnX', 'x'); btn('btnY', 'y');

document.getElementById('interact').onclick = interact;
document.getElementById('menuBtn').onclick = openMenu;
document.getElementById('startBtn').onclick = startGame;

const keys = {};
document.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = 1;
    updateKeys();
    if (e.key === ' ' || e.key === 'z') input.a = 1;
    if (e.key === 'x') input.b = 1;
    if (e.key === 'c') input.x = 1;
    if (e.key === 'Shift') input.y = 1;
    if (e.key === 'Escape') { if (state === 'play') openMenu(); else if (state === 'menu') closeMenu(); }
    if (e.key === 'e' || e.key === 'Enter') interact();
});
document.addEventListener('keyup', e => {
    keys[e.key.toLowerCase()] = 0;
    updateKeys();
    if (e.key === ' ' || e.key === 'z') input.a = 0;
    if (e.key === 'x') input.b = 0;
    if (e.key === 'c') input.x = 0;
    if (e.key === 'Shift') input.y = 0;
});

function updateKeys() {
    if (!joy.on) {
        input.mx = (keys['d'] || keys['arrowright'] ? 1 : 0) - (keys['a'] || keys['arrowleft'] ? 1 : 0);
        input.my = (keys['s'] || keys['arrowdown'] ? 1 : 0) - (keys['w'] || keys['arrowup'] ? 1 : 0);
    }
}

async function init() {
    await preload();
    initSelect();
    console.log('Game Ready!');
}

init();
</script>
</body>
</html>
