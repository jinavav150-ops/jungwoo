<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì •ìš°ì˜ í¬ì¼“ëª¬ RPG - ê³ í€„ë¦¬í‹° ë²„ì „</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Pretendard', 'Segoe UI', 'Malgun Gothic', sans-serif; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); overflow: hidden; position: fixed; width: 100%; height: 100%; }
        canvas { display: block; touch-action: none; }
        
        /* ê³ í€„ë¦¬í‹° HUD */
        .hud { position: absolute; top: 20px; left: 20px; z-index: 10; display: none; }
        .hud.show { display: block; }
        .hud-box { 
            background: linear-gradient(145deg, rgba(30, 30, 46, 0.95), rgba(20, 20, 35, 0.95));
            backdrop-filter: blur(10px);
            padding: 16px 20px;
            border-radius: 20px;
            border: 3px solid rgba(255, 215, 0, 0.7);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5),
                       inset 0 1px 0 rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 14px;
            min-width: 280px;
            position: relative;
            overflow: hidden;
        }
        .hud-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.8), transparent);
        }
        .hud-row { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
        .hud-icon { width: 60px; height: 60px; border-radius: 12px; border: 3px solid #ffd700; object-fit: cover; background: rgba(0,0,0,0.3); }
        .hud-name { color: #ffd700; font-weight: 800; font-size: 18px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .hud-lv { background: linear-gradient(135deg, #c0392b, #e74c3c); padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 8px; font-weight: bold; }
        .bar-container { margin: 6px 0; }
        .bar-label { display: flex; justify-content: space-between; color: #ddd; font-size: 11px; margin-bottom: 3px; }
        .bar { width: 180px; height: 14px; background: rgba(0, 0, 0, 0.4); border-radius: 7px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); position: relative; }
        .bar-fill { height: 100%; position: relative; transition: width 0.3s ease; }
        .bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 2s infinite;
        }
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .bar-hp { 
            background: linear-gradient(90deg, #00e676, #00c853, #64dd17);
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.5);
        }
        .bar-mp { 
            background: linear-gradient(90deg, #2979ff, #2962ff, #448aff);
            box-shadow: 0 0 15px rgba(41, 121, 255, 0.5);
        }
        .bar-exp { 
            background: linear-gradient(90deg, #e040fb, #d500f9, #aa00ff);
            box-shadow: 0 0 15px rgba(224, 64, 251, 0.5);
        }
        .hud-stats { display: flex; gap: 15px; margin-top: 12px; font-size: 12px; color: #ddd; }
        .hud-stat { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 8px; }
        
        /* ìœ„ì¹˜ í‘œì‹œ */
        .location { 
            position: absolute; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: linear-gradient(135deg, rgba(30, 30, 46, 0.95), rgba(20, 20, 35, 0.95));
            backdrop-filter: blur(10px);
            padding: 10px 25px; 
            border-radius: 20px; 
            border: 2px solid rgba(255, 215, 0, 0.7); 
            color: #ffd700; 
            font-size: 14px; 
            font-weight: bold;
            display: none; 
            z-index: 10; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .location.show { display: block; }
        
        /* ì¡°ì´ìŠ¤í‹± */
        .joy-area { position: absolute; bottom: 30px; left: 30px; width: 140px; height: 140px; z-index: 100; display: none; }
        .joy-area.show { display: block; }
        .joy-base { width: 100%; height: 100%; background: rgba(50, 50, 70, 0.7); backdrop-filter: blur(5px); border-radius: 50%; border: 3px solid rgba(255, 215, 0, 0.5); position: relative; box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .joy-stick { width: 60px; height: 60px; background: radial-gradient(circle at 35% 35%, #aaa, #444); border-radius: 50%; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); border: 3px solid rgba(255,255,255,0.8); box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        
        /* ì•¡ì…˜ ë²„íŠ¼ */
        .btn-area { position: absolute; bottom: 30px; right: 30px; width: 160px; height: 160px; z-index: 100; display: none; }
        .btn-area.show { display: block; }
        .act-btn { 
            position: absolute; 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            border: none;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 28px; 
            color: white; 
            position: relative;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4),
                        0 3px 6px rgba(255, 255, 255, 0.1) inset;
        }
        .act-btn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.2));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .act-btn:active {
            transform: scale(0.92);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3),
                        0 1px 3px rgba(255, 255, 255, 0.1) inset;
        }
        .btn-a { background: linear-gradient(135deg, #e74c3c, #c0392b); right: 0; bottom: 0; }
        .btn-b { background: linear-gradient(135deg, #3498db, #2980b9); left: 0; bottom: 0; }
        .btn-x { background: linear-gradient(135deg, #f39c12, #e67e22); right: 0; top: 0; }
        .btn-y { background: linear-gradient(135deg, #2ecc71, #27ae60); left: 0; top: 0; }
        .cd { position: absolute; inset: 0; background: rgba(0,0,0,0.8); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; }
        .cd.show { display: flex; }
        
        /* ë©”ë‰´ ë²„íŠ¼ */
        .menu-btn { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            width: 50px; 
            height: 50px; 
            background: linear-gradient(135deg, rgba(30, 30, 46, 0.95), rgba(20, 20, 35, 0.95));
            backdrop-filter: blur(10px);
            border: 3px solid #ffd700; 
            border-radius: 12px; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            color: #ffd700;
            z-index: 100; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .menu-btn:active { transform: scale(0.95); }
        .menu-btn.show { display: flex; }
        
        /* ìƒí˜¸ì‘ìš© ë²„íŠ¼ */
        .interact { 
            position: absolute; 
            bottom: 200px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: linear-gradient(135deg, #9b59b6, #8e44ad); 
            padding: 12px 30px; 
            border-radius: 20px; 
            border: 3px solid #ffd700; 
            color: #fff; 
            font-size: 14px; 
            font-weight: bold;
            display: none; 
            z-index: 90; 
            box-shadow: 0 8px 25px rgba(155, 89, 182, 0.4);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .interact:active { transform: translateX(-50%) scale(0.95); }
        .interact.show { display: block; }
        
        /* ìŠ¤í¬ë¦° ê³µí†µ */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; padding: 20px; overflow-y: auto; }
        .screen.show { display: flex; }
        
        /* ì‹œì‘ í™”ë©´ */
        #startScreen { 
            background: linear-gradient(135deg, #1a2980, #26d0ce); 
            justify-content: flex-start; 
            padding-top: 40px; 
        }
        .title { 
            font-size: 2.2em; 
            background: linear-gradient(135deg, #ffd700, #ff9800, #ff5722); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            font-weight: 900; 
            margin-bottom: 8px; 
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
        }
        .subtitle { color: rgba(255,255,255,0.9); font-size: 16px; margin-bottom: 30px; font-weight: 300; }
        .poke-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 350px; width: 100%; }
        .poke-card { 
            background: rgba(255,255,255,0.95); 
            border-radius: 15px; 
            padding: 15px; 
            text-align: center; 
            border: 4px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .poke-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .poke-card.sel { border-color: #ff9800; transform: translateY(-8px); box-shadow: 0 20px 40px rgba(255, 152, 0, 0.3); }
        .poke-card img { width: 80px; height: 80px; image-rendering: pixelated; }
        .poke-card .name { color: #2c3e50; font-weight: 800; font-size: 14px; margin-top: 8px; }
        .poke-card .type { 
            color: #fff; 
            font-size: 11px; 
            background: #e74c3c; 
            padding: 3px 10px; 
            border-radius: 12px; 
            display: inline-block; 
            margin-top: 5px; 
            font-weight: bold;
        }
        .start-btn { 
            margin-top: 30px; 
            padding: 15px 50px; 
            background: linear-gradient(135deg, #ff9800, #ff5722); 
            color: #fff; 
            border: none; 
            border-radius: 30px; 
            font-weight: 800; 
            font-size: 16px;
            box-shadow: 0 10px 30px rgba(255, 87, 34, 0.4);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .start-btn:active { transform: scale(0.95); }
        .start-btn:disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; }
        
        /* íŒì—… ê³µí†µ */
        .popup { background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        .popup-box { 
            background: linear-gradient(180deg, #2c3e50, #1a252f); 
            border: 4px solid #ffd700; 
            border-radius: 25px; 
            padding: 25px; 
            max-width: 380px; 
            width: 90%; 
            max-height: 80vh; 
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .popup-title { 
            color: #ffd700; 
            font-size: 1.5em; 
            text-align: center; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #ffd700; 
            padding-bottom: 12px; 
            font-weight: 800;
        }
        .p-btn { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0; 
            border: none; 
            border-radius: 12px; 
            font-weight: 800; 
            color: #fff; 
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .p-btn:active { transform: scale(0.97); }
        .p-btn.green { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .p-btn.blue { background: linear-gradient(135deg, #2980b9, #3498db); }
        .p-btn.red { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        
        /* ìƒì  */
        .shop-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .shop-tab { flex: 1; padding: 10px; background: #34495e; border: none; border-radius: 10px; color: #aaa; font-size: 12px; font-weight: bold; cursor: pointer; }
        .shop-tab.active { background: linear-gradient(135deg, #f39c12, #e67e22); color: #000; }
        .shop-list { max-height: 250px; overflow-y: auto; }
        .shop-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            background: rgba(255,255,255,0.1); 
            padding: 12px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            border-left: 4px solid #ffd700;
        }
        .shop-item-icon { font-size: 32px; }
        .shop-item-info { flex: 1; }
        .shop-item-name { color: #fff; font-size: 14px; font-weight: bold; }
        .shop-item-desc { color: #aaa; font-size: 11px; margin-top: 3px; }
        .shop-item-price { color: #ffd700; font-size: 12px; font-weight: bold; }
        .buy-btn { 
            background: linear-gradient(135deg, #27ae60, #2ecc71); 
            border: none; 
            padding: 8px 15px; 
            border-radius: 6px; 
            color: #fff; 
            font-size: 12px; 
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .buy-btn:active { transform: scale(0.95); }
        .buy-btn:disabled { background: #555; cursor: not-allowed; }
        
        /* ì¸ë²¤í† ë¦¬ */
        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .inv-slot { 
            aspect-ratio: 1; 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 28px; 
            border: 3px solid transparent;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .inv-slot:hover { transform: scale(1.05); }
        .inv-slot.sel { border-color: #ffd700; transform: scale(1.05); box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        .inv-slot .cnt { position: absolute; bottom: 5px; right: 5px; font-size: 12px; color: #ffd700; font-weight: bold; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 10px; }
        .inv-detail { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px; display: none; }
        .inv-detail.show { display: block; }
        .inv-btns { display: flex; gap: 10px; margin-top: 12px; }
        .inv-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 12px; color: #fff; font-weight: bold; cursor: pointer; }
        .inv-btn.use { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .inv-btn.drop { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        
        /* ì¥ë¹„ */
        .equip-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .equip-slot { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #ffd700; }
        .equip-slot-label { color: #aaa; font-size: 11px; margin-bottom: 5px; }
        .equip-slot-icon { font-size: 32px; margin: 8px 0; }
        .equip-slot-name { color: #fff; font-size: 12px; font-weight: bold; }
        .equip-stats { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; }
        .equip-stat { display: flex; justify-content: space-between; color: #aaa; font-size: 12px; margin: 5px 0; }
        .equip-stat span:last-child { color: #2ecc71; font-weight: bold; }
        
        /* ëŒ€í™”ì°½ */
        .dialog { 
            position: absolute; 
            bottom: 100px; 
            left: 20px; 
            right: 20px; 
            background: linear-gradient(135deg, rgba(30, 30, 46, 0.98), rgba(20, 20, 35, 0.98));
            backdrop-filter: blur(10px);
            border: 4px solid #ffd700; 
            border-radius: 20px; 
            padding: 20px; 
            display: none; 
            z-index: 150; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .dialog.show { display: block; }
        .dialog-name { color: #ffd700; font-weight: 800; margin-bottom: 10px; font-size: 16px; border-bottom: 1px solid rgba(255, 215, 0, 0.3); padding-bottom: 8px; }
        .dialog-text { color: #fff; font-size: 14px; line-height: 1.6; margin-bottom: 15px; }
        .dialog-opts { margin-top: 15px; }
        .dialog-opt { 
            background: rgba(255,255,255,0.1); 
            padding: 12px; 
            border-radius: 10px; 
            color: #fff; 
            border: none; 
            width: 100%; 
            text-align: left; 
            font-size: 14px; 
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .dialog-opt:hover { background: rgba(255,215,0,0.3); }
        
        /* ê²Œì„ì˜¤ë²„ */
        .go-title { color: #ff6b6b; font-size: 2em; text-align: center; margin-bottom: 20px; font-weight: 900; text-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .go-stats { margin-bottom: 25px; }
        .go-stat { display: flex; justify-content: space-between; color: #fff; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 8px 0; font-size: 14px; }
        .go-stat span:last-child { color: #ffd700; font-weight: bold; }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .hud-box { min-width: 240px; padding: 12px 16px; }
            .bar { width: 150px; }
            .joy-area, .btn-area { transform: scale(0.9); }
            .poke-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 480px) {
            .hud-box { min-width: 200px; }
            .bar { width: 120px; }
            .joy-area, .btn-area { transform: scale(0.8); bottom: 20px; }
            .act-btn { width: 60px; height: 60px; font-size: 24px; }
            .poke-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        }
    </style>
</head>
<body>
    <canvas id="c"></canvas>
    
    <!-- ê²Œì„ HUD -->
    <div class="hud" id="hud">
        <div class="hud-box">
            <div class="hud-row">
                <img class="hud-icon" id="hudIcon" src="" alt="í¬ì¼“ëª¬">
                <div style="flex: 1;">
                    <div>
                        <span class="hud-name" id="hudName">-</span>
                        <span class="hud-lv">Lv.<span id="hudLv">1</span></span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-label">
                            <span style="color:#2ecc71">HP</span>
                            <span id="hpText">0/0</span>
                        </div>
                        <div class="bar">
                            <div class="bar-fill bar-hp" id="hudHp"></div>
                        </div>
                    </div>
                    <div class="bar-container">
                        <div class="bar-label">
                            <span style="color:#3498db">MP</span>
                            <span id="mpText">0/0</span>
                        </div>
                        <div class="bar">
                            <div class="bar-fill bar-mp" id="hudMp"></div>
                        </div>
                    </div>
                    <div class="bar-container">
                        <div class="bar-label">
                            <span style="color:#9b59b6">EXP</span>
                            <span id="expText">0/0</span>
                        </div>
                        <div class="bar">
                            <div class="bar-fill bar-exp" id="hudExp"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="hud-stats">
                <div class="hud-stat">
                    <i class="fas fa-fist-raised"></i>
                    <span id="hudAtk">10</span>
                </div>
                <div class="hud-stat">
                    <i class="fas fa-shield-alt"></i>
                    <span id="hudDef">5</span>
                </div>
                <div class="hud-stat">
                    <i class="fas fa-coins"></i>
                    <span id="hudGold">0</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="location" id="loc">ğŸ  íƒœì´ˆë§ˆì„</div>
    <div class="menu-btn" id="menuBtn"><i class="fas fa-bars"></i></div>
    
    <!-- ì¡°ì´ìŠ¤í‹± ë° ë²„íŠ¼ -->
    <div class="joy-area" id="joyArea">
        <div class="joy-base" id="joyBase">
            <div class="joy-stick" id="joyStick"></div>
        </div>
    </div>
    
    <div class="btn-area" id="btnArea">
        <div class="act-btn btn-a" id="btnA">
            <i class="fas fa-bolt"></i>
        </div>
        <div class="act-btn btn-b" id="btnB">
            <i class="fas fa-star"></i>
            <div class="cd" id="cdB"></div>
        </div>
        <div class="act-btn btn-x" id="btnX">
            <i class="fas fa-fire"></i>
            <div class="cd" id="cdX"></div>
        </div>
        <div class="act-btn btn-y" id="btnY">
            <i class="fas fa-wind"></i>
            <div class="cd" id="cdY"></div>
        </div>
    </div>
    
    <div class="interact" id="interact">
        <i class="fas fa-comments"></i> ëŒ€í™”í•˜ê¸°
    </div>
    
    <!-- ëŒ€í™”ì°½ -->
    <div class="dialog" id="dialog">
        <div class="dialog-name" id="dName">???</div>
        <div class="dialog-text" id="dText"></div>
        <div class="dialog-opts" id="dOpts"></div>
    </div>
    
    <!-- ì‹œì‘ í™”ë©´ -->
    <div class="screen show" id="startScreen">
        <div class="title">í¬ì¼“ëª¬ RPG ì–´ë“œë²¤ì²˜</div>
        <div class="subtitle">ë‹¹ì‹ ì˜ ëª¨í—˜ì„ ì‹œì‘í•˜ì„¸ìš”!</div>
        <div class="poke-grid" id="pokeGrid"></div>
        <button class="start-btn" id="startBtn" disabled>
            <i class="fas fa-gamepad"></i> í¬ì¼“ëª¬ ì„ íƒ í•„ìš”
        </button>
    </div>
    
    <!-- ë©”ë‰´ í™”ë©´ -->
    <div class="screen popup" id="menuScreen">
        <div class="popup-box">
            <div class="popup-title">
                <i class="fas fa-pause-circle"></i> ë©”ë‰´
            </div>
            <button class="p-btn green" onclick="closeMenu()">
                <i class="fas fa-play"></i> ê²Œì„ ê³„ì†
            </button>
            <button class="p-btn blue" onclick="openInv()">
                <i class="fas fa-backpack"></i> ì¸ë²¤í† ë¦¬
            </button>
            <button class="p-btn blue" onclick="openEquip()">
                <i class="fas fa-helmet-battle"></i> ì¥ë¹„
            </button>
            <button class="p-btn red" onclick="toTitle()">
                <i class="fas fa-home"></i> íƒ€ì´í‹€ë¡œ
            </button>
        </div>
    </div>
    
    <!-- ìƒì  í™”ë©´ -->
    <div class="screen popup" id="shopScreen">
        <div class="popup-box">
            <div class="popup-title">
                <i class="fas fa-store"></i> í¬ì¼“ëª¬ ë§ˆíŠ¸
            </div>
            <div class="shop-tabs">
                <button class="shop-tab active" onclick="shopTab(0,this)">ì†Œë¹„ ì•„ì´í…œ</button>
                <button class="shop-tab" onclick="shopTab(1,this)">ì¥ë¹„ ì•„ì´í…œ</button>
            </div>
            <div class="shop-list" id="shopList"></div>
            <div style="text-align:center; color:#ffd700; margin:15px 0; font-size:16px; font-weight:bold;">
                <i class="fas fa-coins"></i> ë³´ìœ  ê³¨ë“œ: <span id="shopGold">0</span>
            </div>
            <button class="p-btn blue" onclick="closeShop()">
                <i class="fas fa-times"></i> ë‹«ê¸°
            </button>
        </div>
    </div>
    
    <!-- ì¸ë²¤í† ë¦¬ í™”ë©´ -->
    <div class="screen popup" id="invScreen">
        <div class="popup-box">
            <div class="popup-title">
                <i class="fas fa-backpack"></i> ì¸ë²¤í† ë¦¬
            </div>
            <div class="inv-grid" id="invGrid"></div>
            <div class="inv-detail" id="invDetail">
                <div id="invName" style="color:#ffd700;font-weight:bold;font-size:16px"></div>
                <div id="invDesc" style="color:#aaa;font-size:12px;margin:8px 0"></div>
                <div class="inv-btns">
                    <button class="inv-btn use" id="invUse">ì‚¬ìš©</button>
                    <button class="inv-btn drop" onclick="dropItem()">ë²„ë¦¬ê¸°</button>
                </div>
            </div>
            <button class="p-btn blue" onclick="closeInv()">
                <i class="fas fa-times"></i> ë‹«ê¸°
            </button>
        </div>
    </div>
    
    <!-- ì¥ë¹„ í™”ë©´ -->
    <div class="screen popup" id="equipScreen">
        <div class="popup-box">
            <div class="popup-title">
                <i class="fas fa-helmet-battle"></i> ì¥ë¹„
            </div>
            <div class="equip-slots" id="equipSlots"></div>
            <div class="equip-stats" id="equipStats"></div>
            <button class="p-btn blue" onclick="closeEquip()">
                <i class="fas fa-times"></i> ë‹«ê¸°
            </button>
        </div>
    </div>
    
    <!-- ê²Œì„ì˜¤ë²„ í™”ë©´ -->
    <div class="screen popup" id="goScreen">
        <div class="popup-box">
            <div class="go-title">
                <i class="fas fa-skull-crossbones"></i> GAME OVER
            </div>
            <div class="go-stats">
                <div class="go-stat">
                    <span>ìµœì¢… ë ˆë²¨</span>
                    <span id="goLv">1</span>
                </div>
                <div class="go-stat">
                    <span>ì²˜ì¹˜í•œ í¬ì¼“ëª¬</span>
                    <span id="goKills">0</span>
                </div>
                <div class="go-stat">
                    <span>ë³´ìœ  ê³¨ë“œ</span>
                    <span id="goGold">0</span>
                </div>
            </div>
            <button class="p-btn green" onclick="respawn()">
                <i class="fas fa-redo"></i> ë§ˆì„ì—ì„œ ë¶€í™œ
            </button>
            <button class="p-btn red" onclick="toTitle()">
                <i class="fas fa-home"></i> íƒ€ì´í‹€ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>
    
<script>
// ê²Œì„ ìƒìˆ˜ ë° ë³€ìˆ˜ ì •ì˜
const C = document.getElementById('c'), X = C.getContext('2d');
const resize = () => { C.width = innerWidth; C.height = innerHeight; };
resize(); onresize = resize;

// ê³ í€„ë¦¬í‹° íˆ¬ì‚¬ì²´ ì´ë¯¸ì§€ URL (ì‹¤ì œ ì´ë¯¸ì§€ë¡œ êµì²´ ê°€ëŠ¥)
const PROJECTILE_IMAGES = {
    electric: 'https://img.icons8.com/color/96/000000/lightning-bolt.png',
    fire: 'https://img.icons8.com/color/96/000000/fire.png',
    water: 'https://img.icons8.com/color/96/000000/water.png',
    ghost: 'https://img.icons8.com/color/96/000000/ghost.png',
    normal: 'https://img.icons8.com/color/96/000000/star.png',
    healing: 'https://img.icons8.com/color/96/000000/heart-plus.png'
};

// ê²Œì„ ë°ì´í„°
const POKE = {
    pikachu: { id: 25, name: 'í”¼ì¹´ì¸„', type: 'ì „ê¸°', hp: 110, mp: 60, atk: 16, def: 8, spd: 6, color: '#f1c40f', projectile: 'electric' },
    charmander: { id: 4, name: 'íŒŒì´ë¦¬', type: 'ë¶ˆê½ƒ', hp: 100, mp: 70, atk: 20, def: 6, spd: 5, color: '#e74c3c', projectile: 'fire' },
    squirtle: { id: 7, name: 'ê¼¬ë¶€ê¸°', type: 'ë¬¼', hp: 130, mp: 50, atk: 14, def: 12, spd: 4, color: '#3498db', projectile: 'water' },
    bulbasaur: { id: 1, name: 'ì´ìƒí•´ì”¨', type: 'í’€', hp: 120, mp: 65, atk: 16, def: 10, spd: 4.5, color: '#2ecc71', projectile: 'normal' },
    eevee: { id: 133, name: 'ì´ë¸Œì´', type: 'ë…¸ë§', hp: 105, mp: 55, atk: 15, def: 9, spd: 5.5, color: '#c8a87c', projectile: 'normal' },
    gengar: { id: 94, name: 'íŒ¬í…€', type: 'ê³ ìŠ¤íŠ¸', hp: 90, mp: 80, atk: 22, def: 5, spd: 6.5, color: '#9b59b6', projectile: 'ghost' }
};

const ENEMY = {
    rattata: { id: 19, name: 'ê¼¬ë ›', hp: 40, atk: 7, def: 3, spd: 2.5, exp: 15, gold: 8 },
    pidgey: { id: 16, name: 'êµ¬êµ¬', hp: 45, atk: 8, def: 4, spd: 3, exp: 18, gold: 10 },
    zubat: { id: 41, name: 'ì£¼ë±ƒ', hp: 55, atk: 10, def: 4, spd: 3.5, exp: 22, gold: 12 },
    geodude: { id: 74, name: 'ê¼¬ë§ˆëŒ', hp: 80, atk: 14, def: 12, spd: 1.5, exp: 28, gold: 18 }
};

const ITEMS = {
    potion: { name: 'íšŒë³µì•½', icon: 'ğŸ§´', desc: 'HP 50 íšŒë³µ', price: 50, type: 'use', eff: { hp: 50 } },
    superPotion: { name: 'ê³ ê¸‰íšŒë³µì•½', icon: 'ğŸ’Š', desc: 'HP 100 íšŒë³µ', price: 120, type: 'use', eff: { hp: 100 } },
    ether: { name: 'ì´ë”', icon: 'ğŸ’§', desc: 'MP 30 íšŒë³µ', price: 80, type: 'use', eff: { mp: 30 } },
    sword1: { name: 'ë‚ ì¹´ë¡œìš´ ë°œí†±', icon: 'ğŸ—¡ï¸', desc: 'ê³µê²©ë ¥ +5', price: 200, type: 'weapon', stat: { atk: 5 } },
    sword2: { name: 'ê°•ì²  ë°œí†±', icon: 'âš”ï¸', desc: 'ê³µê²©ë ¥ +12', price: 500, type: 'weapon', stat: { atk: 12 } },
    armor1: { name: 'ê°€ì£½ ì¡°ë¼', icon: 'ğŸ¥‹', desc: 'ë°©ì–´ë ¥ +3', price: 150, type: 'armor', stat: { def: 3 } },
    armor2: { name: 'ê°•ì²  ê°‘ì˜·', icon: 'ğŸ›¡ï¸', desc: 'ë°©ì–´ë ¥ +8', price: 400, type: 'armor', stat: { def: 8 } }
};

const MAPS = {
    town: { 
        name: 'íƒœì´ˆë§ˆì„', 
        w: 800, h: 600, 
        colors: ['#90d080', '#80c070'], 
        enemies: false, 
        npcs: [
            { id: 'nurse', x: 400, y: 180, icon: 'ğŸ‘©â€âš•ï¸', name: 'ê°„í˜¸ì‚¬ ë‹¤ì†”', type: 'heal' },
            { id: 'shop', x: 200, y: 280, icon: 'ğŸ§‘â€ğŸ’¼', name: 'ìƒì ì£¼ì¸ í˜¸ì² ', type: 'shop' },
            { id: 'boyoung', x: 600, y: 350, icon: 'ğŸ‘©', name: 'ë³´ì˜ì—„ë§ˆ', type: 'boyoung' }
        ], 
        buildings: [
            { x: 350, y: 80, w: 100, h: 80, color: '#e74c3c', icon: 'ğŸ¥' }, 
            { x: 150, y: 200, w: 100, h: 80, color: '#3498db', icon: 'ğŸª' }
        ],
        portals: [
            { x: 750, y: 250, w: 50, h: 100, to: 'route1', tx: 50, ty: 300, label: '1ë²ˆë„ë¡œ â†’' }
        ] 
    },
    route1: { 
        name: '1ë²ˆë„ë¡œ', 
        w: 1200, h: 800, 
        colors: ['#88c070', '#78b060'], 
        enemies: true, 
        types: ['rattata', 'pidgey'], 
        max: 8, 
        rate: 3000, 
        npcs: [], 
        buildings: [], 
        trees: 15,
        portals: [
            { x: 0, y: 250, w: 50, h: 100, to: 'town', tx: 700, ty: 300, label: 'â† íƒœì´ˆë§ˆì„' }, 
            { x: 1150, y: 350, w: 50, h: 100, to: 'route2', tx: 50, ty: 400, label: '2ë²ˆë„ë¡œ â†’' }
        ] 
    },
    route2: { 
        name: '2ë²ˆë„ë¡œ', 
        w: 1500, h: 1000, 
        colors: ['#80a860', '#70984f'], 
        enemies: true, 
        types: ['pidgey', 'zubat', 'geodude'], 
        max: 12, 
        rate: 2500, 
        npcs: [], 
        buildings: [], 
        trees: 25, 
        rocks: 10,
        portals: [
            { x: 0, y: 350, w: 50, h: 100, to: 'route1', tx: 1100, ty: 400, label: 'â† 1ë²ˆë„ë¡œ' }
        ] 
    }
};

// ê²Œì„ ìƒíƒœ ë³€ìˆ˜
let state = 'title', map = 'town', P = null, enemies = [], projs = [], parts = [], npcs = [], obs = [], portals = [], drops = [];
let cam = { x: 0, y: 0 }, input = { mx: 0, my: 0, a: 0, b: 0, x: 0, y: 0 }, joy = { on: 0, id: null, cx: 0, cy: 0 };
let cd = { a: 0, b: 0, x: 0, y: 0 }, inv = [], equip = { weapon: null, armor: null }, kills = 0, lt = 0, spawnT = 0;
let nearNpc = null, nearPortal = null, selPoke = null, selInv = -1, shopMode = 0;
const imgs = {};

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
const spr = (id, back) => `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon${back ? '/back' : ''}/${id}.png`;
const dist = (a, b) => Math.hypot(a.x - b.x, a.y - b.y);
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const rand = (a, b) => Math.random() * (b - a) + a;
const lerp = (a, b, t) => a + (b - a) * t;

// ì´ë¯¸ì§€ ë¡œë“œ í•¨ìˆ˜
async function loadImg(src) {
    if (imgs[src]) return imgs[src];
    return new Promise(r => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => { imgs[src] = img; r(img); };
        img.onerror = () => r(null);
        img.src = src;
    });
}

// ë¦¬ì†ŒìŠ¤ í”„ë¦¬ë¡œë“œ
async function preload() {
    const urls = [];
    Object.values(POKE).forEach(p => { urls.push(spr(p.id), spr(p.id, 1)); });
    Object.values(ENEMY).forEach(e => { urls.push(spr(e.id), spr(e.id, 1)); });
    Object.values(PROJECTILE_IMAGES).forEach(url => urls.push(url));
    await Promise.all(urls.map(loadImg));
}

// ì‹œì‘ í™”ë©´ ì´ˆê¸°í™”
function initSelect() {
    const g = document.getElementById('pokeGrid');
    g.innerHTML = '';
    Object.entries(POKE).forEach(([k, p]) => {
        const d = document.createElement('div');
        d.className = 'poke-card';
        d.innerHTML = `
            <img src="${spr(p.id)}" alt="${p.name}">
            <div class="name">${p.name}</div>
            <div class="type">${p.type} íƒ€ì…</div>
        `;
        d.onclick = () => {
            document.querySelectorAll('.poke-card').forEach(c => c.classList.remove('sel'));
            d.classList.add('sel');
            selPoke = k;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> ëª¨í—˜ ì‹œì‘!';
        };
        g.appendChild(d);
    });
}

// ê²Œì„ ì‹œì‘
function startGame() {
    if (!selPoke) return;
    const d = POKE[selPoke];
    P = { 
        x: 400, y: 400, w: 56, h: 56, 
        hp: d.hp, maxHp: d.hp, 
        mp: d.mp, maxMp: d.mp, 
        atk: d.atk, def: d.def, spd: d.spd,
        baseAtk: d.atk, baseDef: d.def, baseSpd: d.spd, baseHp: d.hp, 
        lv: 1, exp: 0, expNext: 100, gold: 150,
        pid: d.id, name: d.name, color: d.color, projectileType: d.projectile,
        dir: 'down', inv: 0, dash: 0, dashT: 0 
    };
    inv = [{ id: 'potion', n: 3 }, { id: 'ether', n: 2 }];
    equip = { weapon: null, armor: null };
    kills = 0;
    loadMap('town');
    state = 'play';
    document.getElementById('startScreen').classList.remove('show');
    showUI(1);
    updateHUD();
    lt = performance.now();
    requestAnimationFrame(loop);
}

// UI í‘œì‹œ/ìˆ¨ê¹€
function showUI(s) {
    ['hud', 'loc', 'joyArea', 'btnArea', 'menuBtn'].forEach(id => 
        document.getElementById(id).classList.toggle('show', s));
}

// ë§µ ë¡œë“œ
function loadMap(m) {
    map = m;
    const M = MAPS[m];
    document.getElementById('loc').textContent = (M.enemies ? 'âš”ï¸ ' : 'ğŸ  ') + M.name;
    enemies = []; projs = []; parts = []; npcs = []; obs = []; portals = []; drops = []; spawnT = 0;
    if (M.npcs) M.npcs.forEach(n => npcs.push({ ...n, w: 48, h: 48 }));
    if (M.buildings) M.buildings.forEach(b => obs.push({ ...b, type: 'bld' }));
    if (M.trees) for (let i = 0; i < M.trees; i++) obs.push({ 
        x: rand(50, M.w - 50), y: rand(50, M.h - 50), w: 25, h: 25, type: 'tree' 
    });
    if (M.rocks) for (let i = 0; i < M.rocks; i++) obs.push({ 
        x: rand(50, M.w - 50), y: rand(50, M.h - 50), w: 22, h: 22, type: 'rock' 
    });
    if (M.portals) portals = M.portals.map(p => ({ ...p }));
}

// ë©”ì¸ ê²Œì„ ë£¨í”„
function loop(t) {
    if (state !== 'play') return;
    const dt = Math.min((t - lt) / 1000, 0.1);
    lt = t;
    update(dt);
    render();
    requestAnimationFrame(loop);
}

// ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
function update(dt) {
    const M = MAPS[map];
    updatePlayer(dt, M);
    updateEnemies(dt);
    updateProjs(dt, M);
    updateParts(dt);
    if (M.enemies) spawnEnemies(dt, M);
    checkInteract();
    updateCam(M);
    updateCD();
    updateHUD();
}

// í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸
function updatePlayer(dt, M) {
    if (P.dash) { P.dashT -= dt; if (P.dashT <= 0) P.dash = 0; }
    
    let mx = input.mx, my = input.my;
    if (mx || my) {
        const len = Math.hypot(mx, my);
        if (len > 0) { mx /= len; my /= len; }
        
        // ë°©í–¥ ì„¤ì •
        if (Math.abs(mx) > Math.abs(my)) {
            P.dir = mx < 0 ? 'left' : 'right';
        } else if (Math.abs(my) > 0.1) {
            P.dir = my < 0 ? 'up' : 'down';
        }
        
        const spd = P.dash ? P.spd * 3 : P.spd;
        const nx = P.x + mx * spd * dt * 60;
        const ny = P.y + my * spd * dt * 60;
        
        let ok = 1;
        obs.forEach(o => {
            if (nx > o.x - 15 && nx < o.x + o.w + 15 && ny > o.y - 15 && ny < o.y + o.h + 15) ok = 0;
        });
        if (ok) {
            P.x = clamp(nx, P.w/2, M.w - P.w/2);
            P.y = clamp(ny, P.h/2, M.h - P.h/2);
        }
    }
    
    if (P.inv > 0) P.inv -= dt * 60;
    Object.keys(cd).forEach(k => { if (cd[k] > 0) cd[k] -= dt * 60; });
    
    // ê³µê²© ë° ìŠ¤í‚¬ ì‚¬ìš©
    if (input.a && cd.a <= 0 && M.enemies) { fireAtk(); cd.a = 15; }
    if (input.b && cd.b <= 0 && P.mp >= 10 && M.enemies) { fireSkill(); cd.b = 180; P.mp -= 10; }
    if (input.x && cd.x <= 0 && P.mp >= 25 && M.enemies) { fireSpecial(); cd.x = 300; P.mp -= 25; }
    if (input.y && cd.y <= 0 && !P.dash) { 
        P.dash = 1; 
        P.dashT = 0.15; 
        P.inv = Math.max(P.inv, 15); 
        cd.y = 90; 
        spawnParts(P.x, P.y, P.color, 12); 
    }
    
    // ì•„ì´í…œ íšë“
    drops = drops.filter(d => {
        if (dist(P, d) < 40) { 
            addInv(d.id); 
            spawnParts(d.x, d.y, '#ffd700', 8); 
            return 0; 
        }
        return 1;
    });
}

// ê¸°ë³¸ ê³µê²©
function fireAtk() {
    const dirs = { up: { x: 0, y: -1 }, down: { x: 0, y: 1 }, left: { x: -1, y: 0 }, right: { x: 1, y: 0 } };
    const d = dirs[P.dir];
    const proj = {
        x: P.x + d.x * 25, y: P.y + d.y * 25, 
        vx: d.x * 12, vy: d.y * 12, 
        dmg: P.atk, w: 24, h: 24, 
        type: P.projectileType, 
        own: 'p', 
        life: 60,
        rotation: Math.atan2(d.y, d.x),
        spin: Math.random() * 0.1 - 0.05
    };
    projs.push(proj);
    spawnParts(P.x + d.x * 20, P.y + d.y * 20, P.color, 5);
}

// ìŠ¤í‚¬ ê³µê²©
function fireSkill() {
    for (let i = 0; i < 8; i++) {
        const a = (i / 8) * Math.PI * 2;
        projs.push({
            x: P.x, y: P.y, 
            vx: Math.cos(a) * 8, vy: Math.sin(a) * 8, 
            dmg: Math.floor(P.atk * 1.5), w: 28, h: 28, 
            type: P.projectileType, 
            own: 'p', 
            life: 60,
            rotation: a,
            spin: 0.1
        });
    }
    spawnParts(P.x, P.y, '#3498db', 15);
}

// íŠ¹ìˆ˜ ê³µê²©
function fireSpecial() {
    const r = 140;
    enemies.forEach(e => { 
        if (dist(e, P) < r) dmgEnemy(e, Math.floor(P.atk * 3)); 
    });
    for (let i = 0; i < 25; i++) {
        const a = (i / 25) * Math.PI * 2;
        parts.push({ 
            x: P.x + Math.cos(a) * rand(20, r), 
            y: P.y + Math.sin(a) * rand(20, r), 
            vx: Math.cos(a) * 4, 
            vy: Math.sin(a) * 4, 
            life: 40, 
            color: '#ffd700', 
            sz: rand(4, 10),
            alpha: 1
        });
    }
}

// ì  ìƒì„±
function spawnEnemies(dt, M) {
    spawnT += dt * 1000;
    if (spawnT > M.rate && enemies.length < M.max) {
        spawnT = 0;
        const type = M.types[Math.floor(Math.random() * M.types.length)];
        const d = ENEMY[type];
        const mult = 1 + P.lv * 0.1;
        let x, y;
        do { 
            x = rand(50, M.w - 50); 
            y = rand(50, M.h - 50); 
        } while (dist({ x, y }, P) < 200);
        enemies.push({ 
            x, y, w: 48, h: 48, 
            hp: Math.floor(d.hp * mult), 
            maxHp: Math.floor(d.hp * mult), 
            atk: Math.floor(d.atk * mult), 
            def: d.def, spd: d.spd, 
            exp: d.exp, gold: d.gold, 
            pid: d.id, name: d.name, 
            dir: 'down', atkCd: 0, hit: 0 
        });
    }
}

// ì  ì—…ë°ì´íŠ¸
function updateEnemies(dt) {
    enemies.forEach(e => {
        if (e.hit > 0) e.hit -= dt * 60;
        const dx = P.x - e.x, dy = P.y - e.y, d = Math.hypot(dx, dy);
        if (d > 35) {
            e.x += (dx / d) * e.spd * dt * 60;
            e.y += (dy / d) * e.spd * dt * 60;
            if (Math.abs(dx) > Math.abs(dy)) e.dir = dx < 0 ? 'left' : 'right';
            else e.dir = dy < 0 ? 'up' : 'down';
        }
        if (d < 40 && P.inv <= 0 && e.atkCd <= 0) {
            const dmg = Math.max(1, e.atk - P.def);
            P.hp -= dmg;
            P.inv = 45;
            e.atkCd = 60;
            P.x -= (dx / d) * 25;
            P.y -= (dy / d) * 25;
            spawnParts(P.x, P.y, '#e74c3c', 8);
            if (P.hp <= 0) gameOver();
        }
        if (e.atkCd > 0) e.atkCd -= dt * 60;
    });
}

// ì  ë°ë¯¸ì§€ ì²˜ë¦¬
function dmgEnemy(e, dmg) {
    const d = Math.max(1, dmg - e.def);
    e.hp -= d;
    e.hit = 15;
    // ë°ë¯¸ì§€ í…ìŠ¤íŠ¸ íš¨ê³¼
    parts.push({
        x: e.x, y: e.y - 30,
        vx: rand(-1, 1), vy: -2,
        life: 40,
        color: '#ff6b6b',
        sz: 0,
        text: d.toString(),
        fontSize: 16,
        alpha: 1
    });
    
    if (e.hp <= 0) {
        kills++;
        gainExp(e.exp);
        P.gold += e.gold;
        if (Math.random() < 0.2) drops.push({ 
            x: e.x, y: e.y, 
            id: ['potion', 'ether'][Math.floor(Math.random() * 2)] 
        });
        spawnParts(e.x, e.y, '#ffd700', 15);
        enemies = enemies.filter(en => en !== e);
    }
}

// ê²½í—˜ì¹˜ íšë“
function gainExp(n) {
    P.exp += n;
    while (P.exp >= P.expNext) {
        P.exp -= P.expNext;
        P.lv++;
        P.expNext = Math.floor(100 * Math.pow(1.25, P.lv - 1));
        P.baseHp += 12; P.baseAtk += 3; P.baseDef += 2;
        recalc();
        P.hp = P.maxHp; P.mp = P.maxMp;
        spawnParts(P.x, P.y, '#ffd700', 25);
    }
}

// ìŠ¤íƒ¯ ì¬ê³„ì‚°
function recalc() {
    P.maxHp = P.baseHp;
    P.atk = P.baseAtk + (equip.weapon?.stat?.atk || 0);
    P.def = P.baseDef + (equip.armor?.stat?.def || 0);
}

// íˆ¬ì‚¬ì²´ ì—…ë°ì´íŠ¸
function updateProjs(dt, M) {
    projs = projs.filter(p => {
        p.x += p.vx * dt * 60;
        p.y += p.vy * dt * 60;
        p.life -= dt * 60;
        p.rotation += p.spin;
        
        if (p.x < 0 || p.x > M.w || p.y < 0 || p.y > M.h || p.life <= 0) return 0;
        
        if (p.own === 'p') {
            for (let e of enemies) {
                if (dist(p, e) < e.w / 2 + p.w / 2) { 
                    dmgEnemy(e, p.dmg); 
                    spawnParts(p.x, p.y, '#fff', 6); 
                    return 0; 
                }
            }
        }
        return 1;
    });
}

// íŒŒí‹°í´ ìƒì„±
function spawnParts(x, y, color, n) {
    for (let i = 0; i < n; i++) {
        parts.push({ 
            x, y, 
            vx: rand(-5, 5), vy: rand(-5, 5), 
            life: rand(20, 35), 
            color, 
            sz: rand(3, 8),
            alpha: 1,
            gravity: rand(0.05, 0.15)
        });
    }
}

// íŒŒí‹°í´ ì—…ë°ì´íŠ¸
function updateParts(dt) {
    parts = parts.filter(p => { 
        p.x += p.vx * dt * 60; 
        p.y += p.vy * dt * 60; 
        p.vx *= 0.95; 
        p.vy *= 0.95;
        if (p.gravity) p.vy += p.gravity * dt * 60;
        p.life -= dt * 60; 
        p.alpha = p.life / 25;
        return p.life > 0; 
    });
}

// ìƒí˜¸ì‘ìš© ì²´í¬
function checkInteract() {
    nearNpc = null; nearPortal = null;
    npcs.forEach(n => { if (dist(P, n) < 60) nearNpc = n; });
    portals.forEach(p => { if (P.x > p.x && P.x < p.x + p.w && P.y > p.y && P.y < p.y + p.h) nearPortal = p; });
    const btn = document.getElementById('interact');
    if (nearNpc) { 
        btn.innerHTML = `<i class="fas fa-comments"></i> ${nearNpc.name}`; 
        btn.classList.add('show'); 
    } else if (nearPortal) { 
        btn.innerHTML = `<i class="fas fa-door-open"></i> ${nearPortal.label}`; 
        btn.classList.add('show'); 
    } else btn.classList.remove('show');
}

// ìƒí˜¸ì‘ìš© ì‹¤í–‰
function interact() {
    if (nearNpc) startDialog(nearNpc);
    else if (nearPortal) { 
        P.x = nearPortal.tx; 
        P.y = nearPortal.ty; 
        loadMap(nearPortal.to); 
    }
}

// ëŒ€í™” ì‹œì‘
function startDialog(n) {
    state = 'dialog';
    const d = document.getElementById('dialog');
    const name = document.getElementById('dName');
    const text = document.getElementById('dText');
    const opts = document.getElementById('dOpts');
    name.textContent = n.name;
    opts.innerHTML = '';
    
    if (n.type === 'heal') {
        text.textContent = 'ì–´ì„œì˜¤ì„¸ìš”! í¬ì¼“ëª¬ì„ ì¹˜ë£Œí•´ ë“œë¦´ê¹Œìš”?';
        opts.innerHTML = `
            <button class="dialog-opt" onclick="healP()">
                <i class="fas fa-heart"></i> ë„¤, ì¹˜ë£Œí•´ ì£¼ì„¸ìš”
            </button>
            <button class="dialog-opt" onclick="closeDialog()">
                <i class="fas fa-times"></i> ì•„ë‹ˆìš”
            </button>
        `;
    } else if (n.type === 'shop') {
        text.textContent = 'í¬ì¼“ëª¬ ë§ˆíŠ¸ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤! í•„ìš”í•œ ê²ƒì´ ìˆìœ¼ì‹ ê°€ìš”?';
        opts.innerHTML = `
            <button class="dialog-opt" onclick="closeDialog();openShop()">
                <i class="fas fa-shopping-cart"></i> ì‡¼í•‘í•˜ê¸°
            </button>
            <button class="dialog-opt" onclick="closeDialog()">
                <i class="fas fa-walking"></i> ë‚˜ê°€ê¸°
            </button>
        `;
    } else if (n.type === 'boyoung') {
        text.textContent = 'ì •ìš° ì—‰ë©ì´ ëŒ€!!';
        opts.innerHTML = `
            <button class="dialog-opt" onclick="boyoungStep2()">1ëŒ€</button>
            <button class="dialog-opt" onclick="boyoungStep2()">2ëŒ€</button>
            <button class="dialog-opt" onclick="boyoungStep2()">15ëŒ€</button>
        `;
    }
    d.classList.add('show');
}

// ì¹˜ë£Œ í•¨ìˆ˜
function healP() {
    P.hp = P.maxHp; 
    P.mp = P.maxMp;
    document.getElementById('dText').textContent = 'ì¹˜ë£Œ ì™„ë£Œ! í¬ì¼“ëª¬ì´ ê±´ê°•í•´ì¡ŒìŠµë‹ˆë‹¤. ğŸ’–';
    document.getElementById('dOpts').innerHTML = `
        <button class="dialog-opt" onclick="closeDialog()">
            <i class="fas fa-thumbs-up"></i> ê°ì‚¬í•©ë‹ˆë‹¤!
        </button>
    `;
    updateHUD();
}

// ë³´ì˜ì—„ë§ˆ ì´ë²¤íŠ¸
function boyoungStep2() {
    document.getElementById('dText').textContent = 'ë­˜ë¡œ ë§ì„ë˜?';
    document.getElementById('dOpts').innerHTML = `
        <button class="dialog-opt" onclick="boyoungHit()">ì£¼ê±±</button>
        <button class="dialog-opt" onclick="boyoungHit()">ì•¼êµ¬ë°©ë§ì´</button>
        <button class="dialog-opt" onclick="boyoungHit()">íšŒì´ˆë¦¬</button>
    `;
}

function boyoungHit() {
    P.hp = Math.floor(P.hp / 2);
    document.getElementById('dText').textContent = 'ì•„ì•¼!! ğŸ’¥ ì •ìš° ì—‰ë©ì´ì— ë¶ˆì´ì•¼!';
    document.getElementById('dOpts').innerHTML = `
        <button class="dialog-opt" onclick="closeDialog()">
            <i class="fas fa-sad-cry"></i> í‘í‘...
        </button>
    `;
    updateHUD();
}

// ëŒ€í™”ì°½ ë‹«ê¸°
function closeDialog() {
    document.getElementById('dialog').classList.remove('show');
    state = 'play';
    lt = performance.now();
    requestAnimationFrame(loop);
}

// ìƒì  ì—´ê¸°
function openShop() {
    document.getElementById('shopScreen').classList.add('show');
    document.getElementById('shopGold').textContent = P.gold;
    shopMode = 0;
    renderShop();
    state = 'shop';
}

// ìƒì  ë‹«ê¸°
function closeShop() {
    document.getElementById('shopScreen').classList.remove('show');
    state = 'play';
    lt = performance.now();
    requestAnimationFrame(loop);
}

// ìƒì  íƒ­ ë³€ê²½
function shopTab(m, el) {
    shopMode = m;
    document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderShop();
}

// ìƒì  ë Œë”ë§
function renderShop() {
    const list = document.getElementById('shopList');
    list.innerHTML = '';
    const items = shopMode === 0 ? 
        ['potion', 'superPotion', 'ether'] : 
        ['sword1', 'sword2', 'armor1', 'armor2'];
    
    items.forEach(id => {
        const it = ITEMS[id];
        const d = document.createElement('div');
        d.className = 'shop-item';
        d.innerHTML = `
            <div class="shop-item-icon">${it.icon}</div>
            <div class="shop-item-info">
                <div class="shop-item-name">${it.name}</div>
                <div class="shop-item-desc">${it.desc}</div>
            </div>
            <div>
                <div class="shop-item-price">ğŸ’° ${it.price}</div>
                <button class="buy-btn" onclick="buyItem('${id}')" ${P.gold < it.price ? 'disabled' : ''}>
                    êµ¬ë§¤
                </button>
            </div>
        `;
        list.appendChild(d);
    });
}

// ì•„ì´í…œ êµ¬ë§¤
function buyItem(id) {
    const it = ITEMS[id];
    if (P.gold < it.price) return;
    P.gold -= it.price;
    addInv(id);
    document.getElementById('shopGold').textContent = P.gold;
    renderShop();
}

// ì¸ë²¤í† ë¦¬ ì¶”ê°€
function addInv(id) {
    const ex = inv.find(i => i.id === id);
    if (ex) ex.n++; else inv.push({ id, n: 1 });
}

// ì¸ë²¤í† ë¦¬ ì—´ê¸°
function openInv() {
    closeMenu();
    document.getElementById('invScreen').classList.add('show');
    selInv = -1;
    renderInv();
    state = 'inv';
}

// ì¸ë²¤í† ë¦¬ ë‹«ê¸°
function closeInv() {
    document.getElementById('invScreen').classList.remove('show');
    state = 'play';
    lt = performance.now();
    requestAnimationFrame(loop);
}

// ì¸ë²¤í† ë¦¬ ë Œë”ë§
function renderInv() {
    const g = document.getElementById('invGrid');
    g.innerHTML = '';
    for (let i = 0; i < 12; i++) {
        const s = document.createElement('div');
        s.className = 'inv-slot' + (i === selInv ? ' sel' : '');
        if (inv[i]) { 
            const it = ITEMS[inv[i].id]; 
            s.innerHTML = `${it?.icon || '?'}<span class="cnt">${inv[i].n}</span>`; 
        }
        s.onclick = () => { selInv = i; renderInv(); };
        g.appendChild(s);
    }
    
    const det = document.getElementById('invDetail');
    if (selInv >= 0 && inv[selInv]) {
        const it = ITEMS[inv[selInv].id];
        det.classList.add('show');
        document.getElementById('invName').textContent = it.name;
        document.getElementById('invDesc').textContent = it.desc;
        const btn = document.getElementById('invUse');
        if (it.type === 'use') { 
            btn.textContent = 'ì‚¬ìš©'; 
            btn.onclick = () => useItem(selInv); 
        } else if (it.type === 'weapon' || it.type === 'armor') { 
            btn.textContent = 'ì¥ì°©'; 
            btn.onclick = () => equipItem(selInv); 
        } else { 
            btn.textContent = '-'; 
            btn.onclick = null; 
        }
    } else det.classList.remove('show');
}

// ì•„ì´í…œ ì‚¬ìš©
function useItem(i) {
    const iv = inv[i]; if (!iv) return;
    const it = ITEMS[iv.id];
    if (it.eff?.hp) {
        P.hp = Math.min(P.maxHp, P.hp + it.eff.hp);
        spawnParts(P.x, P.y, '#00e676', 10);
    }
    if (it.eff?.mp) {
        P.mp = Math.min(P.maxMp, P.mp + it.eff.mp);
        spawnParts(P.x, P.y, '#2979ff', 10);
    }
    iv.n--; if (iv.n <= 0) inv.splice(i, 1);
    selInv = -1; renderInv(); updateHUD();
}

// ì•„ì´í…œ ì¥ì°©
function equipItem(i) {
    const iv = inv[i]; if (!iv) return;
    const it = ITEMS[iv.id];
    const slot = it.type === 'weapon' ? 'weapon' : 'armor';
    if (equip[slot]) addInv(equip[slot].id);
    equip[slot] = { ...it, id: iv.id };
    iv.n--; if (iv.n <= 0) inv.splice(i, 1);
    recalc(); selInv = -1; renderInv(); updateHUD();
}

// ì•„ì´í…œ ë²„ë¦¬ê¸°
function dropItem() {
    if (selInv < 0 || !inv[selInv]) return;
    inv[selInv].n--; if (inv[selInv].n <= 0) inv.splice(selInv, 1);
    selInv = -1; renderInv();
}

// ì¥ë¹„ í™”ë©´ ì—´ê¸°
function openEquip() {
    closeMenu();
    document.getElementById('equipScreen').classList.add('show');
    renderEquip();
    state = 'equip';
}

// ì¥ë¹„ í™”ë©´ ë‹«ê¸°
function closeEquip() {
    document.getElementById('equipScreen').classList.remove('show');
    state = 'play';
    lt = performance.now();
    requestAnimationFrame(loop);
}

// ì¥ë¹„ í™”ë©´ ë Œë”ë§
function renderEquip() {
    const s = document.getElementById('equipSlots');
    s.innerHTML = `
        <div class="equip-slot">
            <div class="equip-slot-label">ë¬´ê¸°</div>
            <div class="equip-slot-icon">${equip.weapon?.icon || 'â–'}</div>
            <div class="equip-slot-name">${equip.weapon?.name || 'ì—†ìŒ'}</div>
        </div>
        <div class="equip-slot">
            <div class="equip-slot-label">ë°©ì–´êµ¬</div>
            <div class="equip-slot-icon">${equip.armor?.icon || 'â–'}</div>
            <div class="equip-slot-name">${equip.armor?.name || 'ì—†ìŒ'}</div>
        </div>
    `;
    
    const st = document.getElementById('equipStats');
    st.innerHTML = `
        <div class="equip-stat">
            <span>ê³µê²©ë ¥</span>
            <span>${P.baseAtk} + ${equip.weapon?.stat?.atk || 0}</span>
        </div>
        <div class="equip-stat">
            <span>ë°©ì–´ë ¥</span>
            <span>${P.baseDef} + ${equip.armor?.stat?.def || 0}</span>
        </div>
    `;
}

// ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°
function openMenu() { 
    document.getElementById('menuScreen').classList.add('show'); 
    state = 'menu'; 
}
function closeMenu() { 
    document.getElementById('menuScreen').classList.remove('show'); 
    state = 'play'; 
    lt = performance.now(); 
    requestAnimationFrame(loop); 
}

// íƒ€ì´í‹€ë¡œ ëŒì•„ê°€ê¸°
function toTitle() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('show'));
    document.getElementById('startScreen').classList.add('show');
    showUI(0);
    state = 'title';
    selPoke = null;
    document.querySelectorAll('.poke-card').forEach(c => c.classList.remove('sel'));
    document.getElementById('startBtn').disabled = true;
    document.getElementById('startBtn').innerHTML = '<i class="fas fa-gamepad"></i> í¬ì¼“ëª¬ì„ ì„ íƒí•˜ì„¸ìš”';
}

// ê²Œì„ì˜¤ë²„
function gameOver() {
    state = 'gameover';
    document.getElementById('goLv').textContent = P.lv;
    document.getElementById('goKills').textContent = kills;
    document.getElementById('goGold').textContent = P.gold;
    document.getElementById('goScreen').classList.add('show');
}

// ë¶€í™œ
function respawn() {
    document.getElementById('goScreen').classList.remove('show');
    P.hp = Math.floor(P.maxHp / 2); 
    P.mp = Math.floor(P.maxMp / 2);
    P.gold = Math.floor(P.gold / 2);
    P.x = 400; 
    P.y = 400;
    loadMap('town');
    state = 'play';
    lt = performance.now();
    requestAnimationFrame(loop);
}

// ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸
function updateCam(M) {
    const tx = P.x - C.width / 2, ty = P.y - C.height / 2;
    cam.x = lerp(cam.x, tx, 0.1);
    cam.y = lerp(cam.y, ty, 0.1);
    cam.x = clamp(cam.x, 0, Math.max(0, M.w - C.width));
    cam.y = clamp(cam.y, 0, Math.max(0, M.h - C.height));
}

// HUD ì—…ë°ì´íŠ¸
function updateHUD() {
    document.getElementById('hudIcon').src = spr(P.pid);
    document.getElementById('hudName').textContent = P.name;
    document.getElementById('hudLv').textContent = P.lv;
    
    const hpPct = P.hp / P.maxHp;
    const mpPct = P.mp / P.maxMp;
    const expPct = P.exp / P.expNext;
    
    document.getElementById('hudHp').style.width = (hpPct * 100) + '%';
    document.getElementById('hudMp').style.width = (mpPct * 100) + '%';
    document.getElementById('hudExp').style.width = (expPct * 100) + '%';
    
    document.getElementById('hpText').textContent = `${Math.floor(P.hp)}/${P.maxHp}`;
    document.getElementById('mpText').textContent = `${Math.floor(P.mp)}/${P.maxMp}`;
    document.getElementById('expText').textContent = `${P.exp}/${P.expNext}`;
    
    document.getElementById('hudAtk').textContent = P.atk;
    document.getElementById('hudDef').textContent = P.def;
    document.getElementById('hudGold').textContent = P.gold;
}

// ì¿¨ë‹¤ìš´ ì—…ë°ì´íŠ¸
function updateCD() {
    const show = (id, v) => { 
        const e = document.getElementById(id); 
        if (v > 0) { 
            e.classList.add('show'); 
            e.textContent = Math.ceil(v / 60); 
        } else e.classList.remove('show'); 
    };
    show('cdB', cd.b);
    show('cdX', cd.x);
    show('cdY', cd.y);
}

// ë Œë”ë§
function render() {
    const M = MAPS[map];
    X.clearRect(0, 0, C.width, C.height);
    X.save();
    X.translate(-cam.x, -cam.y);
    
    // ë°°ê²½ ë Œë”ë§
    const ts = 48;
    const sx = Math.floor(cam.x / ts) * ts;
    const sy = Math.floor(cam.y / ts) * ts;
    
    for (let x = sx; x < sx + C.width + ts * 2 && x < M.w; x += ts) {
        for (let y = sy; y < sy + C.height + ts * 2 && y < M.h; y += ts) {
            X.fillStyle = M.colors[(Math.floor(x/ts) + Math.floor(y/ts)) % 2];
            X.fillRect(x, y, ts, ts);
        }
    }
    
    // í¬íƒˆ ë Œë”ë§
    portals.forEach(p => {
        X.fillStyle = 'rgba(147, 112, 219, 0.6)';
        X.fillRect(p.x, p.y, p.w, p.h);
        X.strokeStyle = '#9b59b6';
        X.lineWidth = 3;
        X.strokeRect(p.x, p.y, p.w, p.h);
        
        X.fillStyle = '#fff'; 
        X.font = 'bold 11px sans-serif'; 
        X.textAlign = 'center';
        X.fillText(p.label, p.x + p.w/2, p.y - 8);
    });
    
    // ê±´ë¬¼ ë Œë”ë§
    obs.filter(o => o.type === 'bld').forEach(b => {
        X.fillStyle = b.color; 
        X.fillRect(b.x, b.y, b.w, b.h);
        X.fillStyle = '#fff'; 
        X.font = '32px sans-serif'; 
        X.textAlign = 'center';
        X.fillText(b.icon, b.x + b.w/2, b.y + b.h/2 + 10);
    });
    
    // ë‚˜ë¬´/ë°”ìœ„ ë Œë”ë§
    obs.filter(o => o.type === 'tree' || o.type === 'rock').forEach(o => {
        X.font = '36px sans-serif'; 
        X.textAlign = 'center';
        X.fillText(o.type === 'tree' ? 'ğŸŒ²' : 'ğŸª¨', o.x + o.w/2, o.y + o.h/2 + 12);
    });
    
    // ë“œë¡­ ì•„ì´í…œ ë Œë”ë§
    drops.forEach(d => {
        const it = ITEMS[d.id];
        X.save();
        X.globalAlpha = 0.8;
        X.font = '24px sans-serif'; 
        X.textAlign = 'center';
        const floatY = d.y + Math.sin(Date.now()/300) * 8;
        X.fillText(it?.icon || '?', d.x, floatY);
        
        // ë¹›ë‚˜ëŠ” íš¨ê³¼
        X.globalAlpha = 0.3;
        X.shadowColor = '#ffd700';
        X.shadowBlur = 15;
        X.fillText(it?.icon || '?', d.x, floatY);
        X.shadowBlur = 0;
        X.restore();
    });
    
    // NPC ë Œë”ë§
    npcs.forEach(n => { 
        X.font = '36px sans-serif'; 
        X.textAlign = 'center'; 
        X.fillText(n.icon, n.x, n.y + 12); 
    });
    
    // íŒŒí‹°í´ ë Œë”ë§
    parts.forEach(p => {
        X.globalAlpha = p.alpha;
        if (p.text) {
            X.fillStyle = p.color;
            X.font = `bold ${p.fontSize}px sans-serif`;
            X.textAlign = 'center';
            X.fillText(p.text, p.x, p.y);
        } else {
            X.fillStyle = p.color;
            X.beginPath(); 
            X.arc(p.x, p.y, p.sz, 0, Math.PI * 2); 
            X.fill();
        }
    });
    X.globalAlpha = 1;
    
    // íˆ¬ì‚¬ì²´ ë Œë”ë§
    projs.forEach(p => {
        X.save();
        X.translate(p.x, p.y);
        X.rotate(p.rotation);
        
        const img = imgs[PROJECTILE_IMAGES[p.type] || PROJECTILE_IMAGES.normal];
        if (img) {
            X.drawImage(img, -p.w/2, -p.h/2, p.w, p.h);
        } else {
            X.fillStyle = getProjectileColor(p.type);
            X.beginPath(); 
            X.arc(0, 0, p.w/2, 0, Math.PI * 2); 
            X.fill();
        }
        
        // ë¹›ë‚˜ëŠ” íš¨ê³¼
        X.globalAlpha = 0.5;
        X.shadowColor = getProjectileColor(p.type);
        X.shadowBlur = 15;
        if (img) {
            X.drawImage(img, -p.w/2, -p.h/2, p.w, p.h);
        } else {
            X.beginPath(); 
            X.arc(0, 0, p.w/2, 0, Math.PI * 2); 
            X.fill();
        }
        X.restore();
    });
    
    // ì  ë Œë”ë§
    enemies.forEach(e => drawChar(e, true));
    
    // í”Œë ˆì´ì–´ ë Œë”ë§
    if (P.inv <= 0 || Math.floor(Date.now()/80) % 2 === 0) drawChar(P, false);
    
    X.restore();
}

// ìºë¦­í„° ë Œë”ë§
function drawChar(c, isEnemy) {
    const back = c.dir === 'up';
    const img = imgs[spr(c.pid, back)];
    
    // ê·¸ë¦¼ì
    X.fillStyle = 'rgba(0,0,0,0.3)';
    X.beginPath(); 
    X.ellipse(c.x, c.y + c.h/2, c.w/3, 10, 0, 0, Math.PI * 2); 
    X.fill();
    
    if (img) {
        X.save();
        if (c.hit > 0) X.filter = 'brightness(2)';
        if (c.dir === 'right') {
            X.translate(c.x, c.y);
            X.scale(-1, 1);
            X.drawImage(img, -c.w/2, -c.h/2, c.w, c.h);
        } else {
            X.drawImage(img, c.x - c.w/2, c.y - c.h/2, c.w, c.h);
        }
        X.restore();
    } else {
        X.fillStyle = c.color;
        X.fillRect(c.x - c.w/2, c.y - c.h/2, c.w, c.h);
    }
    
    // ì  HP ë°”
    if (isEnemy) {
        const pct = c.hp / c.maxHp;
        X.fillStyle = 'rgba(0,0,0,0.7)'; 
        X.fillRect(c.x - 25, c.y - c.h/2 - 15, 50, 8);
        X.fillStyle = pct > 0.5 ? '#2ecc71' : pct > 0.2 ? '#f39c12' : '#e74c3c';
        X.fillRect(c.x - 25, c.y - c.h/2 - 15, 50 * pct, 8);
        
        // ì  ì´ë¦„
        X.fillStyle = '#fff';
        X.font = 'bold 12px sans-serif';
        X.textAlign = 'center';
        X.fillText(c.name, c.x, c.y - c.h/2 - 25);
    }
}

// íˆ¬ì‚¬ì²´ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
function getProjectileColor(type) {
    const colors = {
        electric: '#FFEB3B',
        fire: '#FF5722',
        water: '#2196F3',
        ghost: '#9C27B0',
        normal: '#FFFFFF',
        healing: '#00E676'
    };
    return colors[type] || '#FFFFFF';
}

// ì…ë ¥ ì²˜ë¦¬
const joyArea = document.getElementById('joyArea');
const joyStick = document.getElementById('joyStick');
const maxD = 40;

function joyStart(e) {
    e.preventDefault();
    const t = e.touches ? e.touches[0] : e;
    const r = joyArea.getBoundingClientRect();
    joy.on = 1;
    joy.cx = r.left + r.width / 2;
    joy.cy = r.top + r.height / 2;
    if (e.touches) joy.id = t.identifier;
    joyMove(e);
}

function joyMove(e) {
    if (!joy.on) return;
    e.preventDefault();
    let t;
    if (e.touches) { 
        for (let x of e.touches) if (x.identifier === joy.id) { t = x; break; } 
        if (!t) return; 
    } else t = e;
    const dx = t.clientX - joy.cx, dy = t.clientY - joy.cy;
    const d = Math.hypot(dx, dy), cd = Math.min(d, maxD), a = Math.atan2(dy, dx);
    const sx = Math.cos(a) * cd, sy = Math.sin(a) * cd;
    joyStick.style.left = `calc(50% + ${sx}px)`;
    joyStick.style.top = `calc(50% + ${sy}px)`;
    input.mx = cd > 5 ? sx / maxD : 0;
    input.my = cd > 5 ? sy / maxD : 0;
}

function joyEnd(e) {
    if (e.touches && e.touches.length > 0) { 
        for (let t of e.touches) if (t.identifier === joy.id) return; 
    }
    joy.on = 0;
    joyStick.style.left = '50%';
    joyStick.style.top = '50%';
    input.mx = 0;
    input.my = 0;
}

// ì¡°ì´ìŠ¤í‹± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
joyArea.addEventListener('touchstart', joyStart, { passive: false });
joyArea.addEventListener('touchmove', joyMove, { passive: false });
joyArea.addEventListener('touchend', joyEnd);
joyArea.addEventListener('touchcancel', joyEnd);
joyArea.addEventListener('mousedown', joyStart);
document.addEventListener('mousemove', e => { if (joy.on) joyMove(e); });
document.addEventListener('mouseup', joyEnd);

// ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
function btn(id, k) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', e => { e.preventDefault(); input[k] = 1; }, { passive: false });
    el.addEventListener('touchend', e => { e.preventDefault(); input[k] = 0; });
    el.addEventListener('mousedown', () => input[k] = 1);
    el.addEventListener('mouseup', () => input[k] = 0);
}
btn('btnA', 'a'); 
btn('btnB', 'b'); 
btn('btnX', 'x'); 
btn('btnY', 'y');

// ê¸°íƒ€ ì¸í„°ë™ì…˜
document.getElementById('interact').onclick = interact;
document.getElementById('menuBtn').onclick = openMenu;
document.getElementById('startBtn').onclick = startGame;

// í‚¤ë³´ë“œ ì…ë ¥
const keys = {};
document.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = 1;
    updateKeys();
    if (e.key === ' ' || e.key === 'z') input.a = 1;
    if (e.key === 'x') input.b = 1;
    if (e.key === 'c') input.x = 1;
    if (e.key === 'Shift') input.y = 1;
    if (e.key === 'Escape') { 
        if (state === 'play') openMenu(); 
        else if (state === 'menu') closeMenu(); 
    }
    if (e.key === 'e' || e.key === 'Enter') interact();
});
document.addEventListener('keyup', e => {
    keys[e.key.toLowerCase()] = 0;
    updateKeys();
    if (e.key === ' ' || e.key === 'z') input.a = 0;
    if (e.key === 'x') input.b = 0;
    if (e.key === 'c') input.x = 0;
    if (e.key === 'Shift') input.y = 0;
});

function updateKeys() {
    if (!joy.on) {
        input.mx = (keys['d'] || keys['arrowright'] ? 1 : 0) - (keys['a'] || keys['arrowleft'] ? 1 : 0);
        input.my = (keys['s'] || keys['arrowdown'] ? 1 : 0) - (keys['w'] || keys['arrowup'] ? 1 : 0);
    }
}

// ê²Œì„ ì´ˆê¸°í™”
async function init() {
    await preload();
    initSelect();
    console.log('ê³ í€„ë¦¬í‹° í¬ì¼“ëª¬ RPG ë¡œë“œ ì™„ë£Œ!');
}

init();
</script>
</body>
</html>
