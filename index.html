<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Ìè¨ÏºìÎ™¨ Ïñ¥ÎìúÎ≤§Ï≤ò</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: #000;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        canvas {
            display: block;
            background: #88c070;
            width: 100%;
            flex: 1;
            touch-action: none;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 10;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.85);
            padding: 10px 15px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #ffd700;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .pokemon-name {
            color: #ffd700;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .hp-bar-bg {
            width: 150px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #555;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
        }

        .hp-bar.low {
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f);
        }

        .game-stats {
            text-align: right;
        }

        .level-display {
            color: #4ecdc4;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .exp-bar {
            width: 100px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 3px;
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9b59b6, #e74c3c);
            transition: width 0.3s;
        }

        .town-name {
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .location-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 50px;
            border-radius: 20px;
            border: 3px solid #ffd700;
            text-align: center;
            z-index: 500;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .location-info h2 {
            color: #ffd700;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .location-info p {
            color: white;
            font-size: 16px;
        }

        /* Î™®Î∞îÏùº Ïª®Ìä∏Î°§ */
        .mobile-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            pointer-events: none;
            z-index: 100;
        }

        .d-pad {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 150px;
            pointer-events: auto;
        }

        .d-pad-btn {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(50, 50, 50, 0.8);
            border: 3px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            cursor: pointer;
        }

        .d-pad-btn:active {
            background: rgba(78, 205, 196, 0.8);
        }

        .d-pad-up {
            top: 0;
            left: 50px;
            border-radius: 8px 8px 0 0;
        }

        .d-pad-down {
            bottom: 0;
            left: 50px;
            border-radius: 0 0 8px 8px;
        }

        .d-pad-left {
            top: 50px;
            left: 0;
            border-radius: 8px 0 0 8px;
        }

        .d-pad-right {
            top: 50px;
            right: 0;
            border-radius: 0 8px 8px 0;
        }

        .d-pad-center {
            top: 50px;
            left: 50px;
            width: 50px;
            height: 50px;
            background: rgba(30, 30, 30, 0.9);
            border-radius: 50%;
        }

        .action-buttons {
            position: absolute;
            bottom: 30px;
            right: 20px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }

        .action-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        .attack-btn {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.4);
        }

        .skill-btn {
            border-color: #9b59b6;
            background: rgba(155, 89, 182, 0.4);
        }

        .skill-cooldown {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            font-weight: bold;
        }

        /* ÏãúÏûë ÌôîÎ©¥ */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        #startScreen.hidden {
            display: none;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 3px 3px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
            text-align: center;
        }

        .subtitle {
            color: white;
            font-size: 16px;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .trainer-name-input {
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #ffd700;
            color: #333;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
            width: 250px;
            font-weight: bold;
        }

        .trainer-name-input::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }

        .pokemon-select {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .pokemon-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 4px solid transparent;
            text-align: center;
            min-width: 140px;
        }

        .pokemon-card.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.3);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .pokemon-preview {
            width: 100px;
            height: 100px;
            margin: 0 auto 10px;
        }

        .pokemon-name-display {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .pokemon-type {
            font-size: 12px;
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 10px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .pokemon-stats {
            font-size: 12px;
            color: #666;
        }

        .start-btn {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            border: 3px solid #ff6b00;
            padding: 15px 40px;
            font-size: 22px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-top: 20px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }

        .start-btn:active {
            transform: scale(0.95);
        }

        .start-btn:disabled {
            background: #666;
            border-color: #444;
            cursor: not-allowed;
        }

        .leaderboard-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 30px;
            font-size: 16px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Í≤åÏûÑÏò§Î≤Ñ ÌôîÎ©¥ */
        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        #gameOverScreen.hidden {
            display: none;
        }

        .game-over-title {
            font-size: 2.5em;
            color: #e74c3c;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
        }

        .final-stats {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #ffd700;
        }

        .stats {
            color: white;
            font-size: 18px;
            margin: 10px 0;
        }

        .restart-btn {
            background: linear-gradient(135deg, #4ecdc4, #45b7af);
            color: white;
            border: 3px solid #2d7a73;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-top: 20px;
        }

        .restart-btn:active {
            transform: scale(0.95);
        }

        /* Î¶¨ÎçîÎ≥¥Îìú */
        #leaderboardScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        #leaderboardScreen.hidden {
            display: none;
        }

        .leaderboard-list {
            width: 100%;
            max-width: 500px;
            margin: 20px 0;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            border: 2px solid transparent;
        }

        .leaderboard-item.top3 {
            background: rgba(255, 215, 0, 0.25);
            border: 2px solid #ffd700;
        }

        .rank {
            font-size: 24px;
            font-weight: bold;
            width: 50px;
        }

        .trainer-info {
            flex: 1;
            margin-left: 15px;
        }

        .trainer-name {
            font-size: 18px;
            font-weight: bold;
        }

        .trainer-pokemon {
            font-size: 12px;
            color: #ddd;
        }

        .score {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
        }

        .close-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid white;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 20px;
        }

        .loading {
            color: white;
            font-size: 18px;
            margin: 20px;
        }

        .level-up-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            z-index: 500;
            animation: popupAppear 0.3s;
            border: 4px solid #ff6b00;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }

        @keyframes popupAppear {
            from {
                transform: translate(-50%, -50%) scale(0);
            }
            to {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .level-up-popup h2 {
            color: #333;
            font-size: 36px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0 rgba(255,255,255,0.5);
        }

        .level-up-popup p {
            color: #666;
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div class="ui-overlay">
            <div class="player-info">
                <div class="stat-box">
                    <div class="pokemon-name" id="pokemonName">ÌîºÏπ¥Ï∏Ñ</div>
                    <div class="hp-bar-bg">
                        <div class="hp-bar" id="hpBar" style="width: 100%;">100/100</div>
                    </div>
                </div>
            </div>
            <div class="stat-box game-stats">
                <div class="town-name" id="townName">ÏãúÏûë ÎßàÏùÑ</div>
                <div class="level-display" id="levelDisplay">Î†àÎ≤®: 1</div>
                <div class="exp-bar">
                    <div class="exp-fill" id="expBar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="mobile-controls">
            <div class="d-pad">
                <div class="d-pad-btn d-pad-up" id="btnUp">‚ñ≤</div>
                <div class="d-pad-btn d-pad-down" id="btnDown">‚ñº</div>
                <div class="d-pad-btn d-pad-left" id="btnLeft">‚óÄ</div>
                <div class="d-pad-btn d-pad-right" id="btnRight">‚ñ∂</div>
                <div class="d-pad-center"></div>
            </div>

            <div class="action-buttons">
                <div class="action-btn attack-btn" id="attackBtn">‚ö°</div>
                <div class="action-btn skill-btn" id="skillBtn">
                    üí•
                    <div class="skill-cooldown hidden" id="skillCooldown">0</div>
                </div>
            </div>
        </div>

        <div id="startScreen">
            <h1>‚ö° Ìè¨ÏºìÎ™¨ Ïñ¥ÎìúÎ≤§Ï≤ò ‚ö°</h1>
            <p class="subtitle">Ìä∏Î†àÏù¥ÎÑà Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÍ≥† Ìè¨ÏºìÎ™¨ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!</p>
            
            <input type="text" class="trainer-name-input" id="trainerName" placeholder="Ìä∏Î†àÏù¥ÎÑà Ïù¥Î¶Ñ" maxlength="10">

            <div class="pokemon-select">
                <div class="pokemon-card" data-pokemon="pikachu">
                    <canvas class="pokemon-preview" width="100" height="100"></canvas>
                    <div class="pokemon-name-display">ÌîºÏπ¥Ï∏Ñ</div>
                    <div class="pokemon-type">Ï†ÑÍ∏∞</div>
                    <div class="pokemon-stats">HP: 100 | Îπ†Î•∏ Í≥µÍ≤©</div>
                </div>
                <div class="pokemon-card" data-pokemon="charmander">
                    <canvas class="pokemon-preview" width="100" height="100"></canvas>
                    <div class="pokemon-name-display">ÌååÏù¥Î¶¨</div>
                    <div class="pokemon-type">Î∂àÍΩÉ</div>
                    <div class="pokemon-stats">HP: 120 | Í∞ïÌïú Í≥µÍ≤©</div>
                </div>
                <div class="pokemon-card" data-pokemon="squirtle">
                    <canvas class="pokemon-preview" width="100" height="100"></canvas>
                    <div class="pokemon-name-display">Íº¨Î∂ÄÍ∏∞</div>
                    <div class="pokemon-type">Î¨º</div>
                    <div class="pokemon-stats">HP: 130 | Î∞©Ïñ¥Î†• ÎÜíÏùå</div>
                </div>
            </div>

            <button class="start-btn" id="startBtn" disabled>Î™®Ìóò ÏãúÏûë!</button>
            <button class="leaderboard-btn" id="showLeaderboardBtn">üèÜ Î¶¨ÎçîÎ≥¥Îìú</button>
        </div>

        <div id="gameOverScreen" class="hidden">
            <h1 class="game-over-title">Í≤åÏûÑ Ïò§Î≤Ñ</h1>
            <div class="final-stats">
                <div class="stats">Î†àÎ≤®: <span id="finalLevel">0</span></div>
                <div class="stats">ÏµúÏ¢Ö ÏúÑÏπò: <span id="finalTown">0</span></div>
                <div class="stats">Ï≤òÏπò: <span id="finalKills">0</span></div>
            </div>
            <p style="color: #4ecdc4; font-size: 16px; margin: 10px 0;">Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!</p>
            <button class="restart-btn" id="restartBtn">Îã§Ïãú ÏãúÏûë</button>
            <button class="leaderboard-btn" id="showLeaderboardBtn2">üèÜ Î¶¨ÎçîÎ≥¥Îìú</button>
        </div>

        <div id="leaderboardScreen" class="hidden">
            <h1>üèÜ Î¶¨ÎçîÎ≥¥Îìú üèÜ</h1>
            <div class="loading" id="leaderboardLoading">Î°úÎî©Ï§ë...</div>
            <div class="leaderboard-list" id="leaderboardList"></div>
            <button class="close-btn" id="closeLeaderboardBtn">Îã´Í∏∞</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, get, query, orderByChild, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAj0M7AuQnOlnWV1ZDcuY0Ij9eOV7SRUlg",
            authDomain: "free-96bc0.firebaseapp.com",
            databaseURL: "https://free-96bc0-default-rtdb.firebaseio.com",
            projectId: "free-96bc0",
            storageBucket: "free-96bc0.firebasestorage.app",
            messagingSenderId: "131017218548",
            appId: "1:131017218548:web:55ee3cb626695ede9841a1"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        window.saveScore = async function(trainerName, pokemon, level, town, kills) {
            try {
                const scoresRef = ref(database, 'pokemon-adventure/scores');
                const newScoreRef = push(scoresRef);
                await set(newScoreRef, {
                    trainerName: trainerName,
                    pokemon: pokemon,
                    level: level,
                    town: town,
                    kills: kills,
                    timestamp: Date.now()
                });
                console.log('Ï†êÏàò Ï†ÄÏû• ÏÑ±Í≥µ!');
            } catch (error) {
                console.error('Ï†êÏàò Ï†ÄÏû• Ïã§Ìå®:', error);
            }
        };

        window.loadLeaderboard = async function() {
            try {
                const scoresRef = ref(database, 'pokemon-adventure/scores');
                const topScoresQuery = query(scoresRef, orderByChild('level'), limitToLast(10));
                const snapshot = await get(topScoresQuery);
                
                const scores = [];
                snapshot.forEach((childSnapshot) => {
                    scores.push(childSnapshot.val());
                });
                
                scores.sort((a, b) => b.level - a.level);
                return scores;
            } catch (error) {
                console.error('Î¶¨ÎçîÎ≥¥Îìú Î°úÎî© Ïã§Ìå®:', error);
                return [];
            }
        };

        console.log('Firebase Ï¥àÍ∏∞Ìôî ÏôÑÎ£å!');
    </script>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 200;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Ìè¨ÏºìÎ™¨ Í∑∏Î¶¨Í∏∞ Ìï®Ïàò
        function drawPokemon(ctx, type, x, y, size) {
            ctx.save();
            
            if (type === 'pikachu') {
                // ÌîºÏπ¥Ï∏Ñ
                // Í∑Ä (ÏôºÏ™Ω)
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.moveTo(x - size * 0.25, y - size * 0.3);
                ctx.lineTo(x - size * 0.4, y - size * 0.7);
                ctx.lineTo(x - size * 0.15, y - size * 0.4);
                ctx.fill();
                
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.moveTo(x - size * 0.35, y - size * 0.65);
                ctx.lineTo(x - size * 0.42, y - size * 0.72);
                ctx.lineTo(x - size * 0.28, y - size * 0.58);
                ctx.fill();
                
                // Í∑Ä (Ïò§Î•∏Ï™Ω)
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.moveTo(x + size * 0.25, y - size * 0.3);
                ctx.lineTo(x + size * 0.4, y - size * 0.7);
                ctx.lineTo(x + size * 0.15, y - size * 0.4);
                ctx.fill();
                
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.moveTo(x + size * 0.35, y - size * 0.65);
                ctx.lineTo(x + size * 0.42, y - size * 0.72);
                ctx.lineTo(x + size * 0.28, y - size * 0.58);
                ctx.fill();
                
                // Î®∏Î¶¨
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(x, y - size * 0.2, size * 0.35, 0, Math.PI * 2);
                ctx.fill();
                
                // Î™∏ÌÜµ
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.ellipse(x, y + size * 0.15, size * 0.3, size * 0.35, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Îàà
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(x - size * 0.15, y - size * 0.25, size * 0.08, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + size * 0.15, y - size * 0.25, size * 0.08, 0, Math.PI * 2);
                ctx.fill();
                
                // Î≥º
                ctx.fillStyle = '#FF6B6B';
                ctx.beginPath();
                ctx.arc(x - size * 0.25, y - size * 0.15, size * 0.1, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + size * 0.25, y - size * 0.15, size * 0.1, 0, Math.PI * 2);
                ctx.fill();
                
                // ÏûÖ
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y - size * 0.1, size * 0.1, 0, Math.PI);
                ctx.stroke();
                
                // Íº¨Î¶¨
                ctx.strokeStyle = '#FFA500';
                ctx.lineWidth = size * 0.15;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(x + size * 0.25, y + size * 0.2);
                ctx.lineTo(x + size * 0.45, y - size * 0.1);
                ctx.lineTo(x + size * 0.55, y - size * 0.3);
                ctx.stroke();
                
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.moveTo(x + size * 0.5, y - size * 0.35);
                ctx.lineTo(x + size * 0.65, y - size * 0.45);
                ctx.lineTo(x + size * 0.6, y - size * 0.25);
                ctx.fill();
                
            } else if (type === 'charmander') {
                // ÌååÏù¥Î¶¨
                // Î™∏ÌÜµ
                ctx.fillStyle = '#FF6B4A';
                ctx.beginPath();
                ctx.ellipse(x, y + size * 0.1, size * 0.35, size * 0.4, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Î®∏Î¶¨
                ctx.fillStyle = '#FF6B4A';
                ctx.beginPath();
                ctx.arc(x, y - size * 0.25, size * 0.3, 0, Math.PI * 2);
                ctx.fill();
                
                // Îàà
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.ellipse(x - size * 0.12, y - size * 0.28, size * 0.1, size * 0.12, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(x + size * 0.12, y - size * 0.28, size * 0.1, size * 0.12, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(x - size * 0.12, y - size * 0.28, size * 0.06, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + size * 0.12, y - size * 0.28, size * 0.06, 0, Math.PI * 2);
                ctx.fill();
                
                // Î∞∞
                ctx.fillStyle = '#FFE4B5';
                ctx.beginPath();
                ctx.ellipse(x, y + size * 0.15, size * 0.25, size * 0.3, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // ÏΩî
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.moveTo(x - size * 0.05, y - size * 0.18);
                ctx.lineTo(x, y - size * 0.12);
                ctx.lineTo(x + size * 0.05, y - size * 0.18);
                ctx.fill();
                
                // Íº¨Î¶¨ (Î∂àÍΩÉ)
                ctx.fillStyle = '#FFA500';
                ctx.beginPath();
                ctx.arc(x + size * 0.4, y - size * 0.1, size * 0.15, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#FF4500';
                ctx.beginPath();
                ctx.arc(x + size * 0.4, y - size * 0.1, size * 0.1, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(x + size * 0.4, y - size * 0.1, size * 0.05, 0, Math.PI * 2);
                ctx.fill();
                
            } else if (type === 'squirtle') {
                // Íº¨Î∂ÄÍ∏∞
                // Îì±ÍªçÏßà
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.ellipse(x, y + size * 0.05, size * 0.4, size * 0.35, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Îì±ÍªçÏßà Î¨¥Îä¨
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 3;
                for (let i = 0; i < 6; i++) {
                    ctx.beginPath();
                    ctx.arc(x, y + size * 0.05, size * 0.15 + i * size * 0.05, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // Î®∏Î¶¨
                ctx.fillStyle = '#4A90E2';
                ctx.beginPath();
                ctx.arc(x, y - size * 0.3, size * 0.25, 0, Math.PI * 2);
                ctx.fill();
                
                // Îàà
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.arc(x - size * 0.1, y - size * 0.32, size * 0.1, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + size * 0.1, y - size * 0.32, size * 0.1, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(x - size * 0.1, y - size * 0.32, size * 0.05, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + size * 0.1, y - size * 0.32, size * 0.05, 0, Math.PI * 2);
                ctx.fill();
                
                // ÏûÖ
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y - size * 0.22, size * 0.08, 0, Math.PI);
                ctx.stroke();
                
                // Íº¨Î¶¨
                ctx.fillStyle = '#4A90E2';
                ctx.beginPath();
                ctx.moveTo(x + size * 0.3, y + size * 0.15);
                ctx.quadraticCurveTo(x + size * 0.45, y + size * 0.2, x + size * 0.5, y + size * 0.3);
                ctx.lineTo(x + size * 0.42, y + size * 0.28);
                ctx.quadraticCurveTo(x + size * 0.38, y + size * 0.18, x + size * 0.28, y + size * 0.18);
                ctx.fill();
            }
            
            ctx.restore();
        }

        // ÌîÑÎ¶¨Î∑∞ Ï∫îÎ≤ÑÏä§ Í∑∏Î¶¨Í∏∞
        document.querySelectorAll('.pokemon-preview').forEach((canvas, index) => {
            const ctx = canvas.getContext('2d');
            const types = ['pikachu', 'charmander', 'squirtle'];
            drawPokemon(ctx, types[index], 50, 55, 35);
        });

        // Í≤åÏûÑ ÏÉÅÌÉú
        let gameState = 'menu';
        let selectedPokemon = null;
        let trainerNameValue = '';
        let player = null;
        let enemies = [];
        let projectiles = [];
        let particles = [];
        let level = 1;
        let exp = 0;
        let expToNextLevel = 100;
        let kills = 0;
        let currentTown = 0;
        let showingLocation = false;

        // ÎßàÏùÑ Îç∞Ïù¥ÌÑ∞
        const towns = [
            { 
                name: 'ÏãúÏûë ÎßàÏùÑ', 
                bgColor: '#88c070',
                treeColor: '#306850',
                houseColor: '#d08060',
                pathColor: '#c8b090',
                enemySpawnRate: 1000
            },
            { 
                name: 'Ïà≤ ÎßàÏùÑ', 
                bgColor: '#507050',
                treeColor: '#204020',
                houseColor: '#8B4513',
                pathColor: '#654321',
                enemySpawnRate: 800
            },
            { 
                name: 'Ìò∏Ïàò ÎßàÏùÑ', 
                bgColor: '#7090d0',
                treeColor: '#306850',
                houseColor: '#f0e0d0',
                pathColor: '#d0c0b0',
                enemySpawnRate: 600
            },
            { 
                name: 'ÏÇ∞ ÎßàÏùÑ', 
                bgColor: '#a08070',
                treeColor: '#505050',
                houseColor: '#909090',
                pathColor: '#787878',
                enemySpawnRate: 500
            }
        ];

        // ÏûÖÎ†•
        const keys = {};

        // Ìè¨ÏºìÎ™¨ Îç∞Ïù¥ÌÑ∞
        const pokemonData = {
            pikachu: {
                name: 'ÌîºÏπ¥Ï∏Ñ',
                type: 'pikachu',
                maxHp: 100,
                speed: 4,
                attackDamage: 20,
                attackRange: 150,
                attackCooldown: 300,
                skillDamage: 60,
                skillRange: 200,
                skillCooldown: 4000,
                color: '#FFD700',
                projectileColor: '#FFFF00'
            },
            charmander: {
                name: 'ÌååÏù¥Î¶¨',
                type: 'charmander',
                maxHp: 120,
                speed: 3,
                attackDamage: 30,
                attackRange: 130,
                attackCooldown: 400,
                skillDamage: 100,
                skillRange: 180,
                skillCooldown: 5000,
                color: '#FF6B4A',
                projectileColor: '#FF4500'
            },
            squirtle: {
                name: 'Íº¨Î∂ÄÍ∏∞',
                type: 'squirtle',
                maxHp: 130,
                speed: 3.5,
                attackDamage: 25,
                attackRange: 140,
                attackCooldown: 350,
                skillDamage: 80,
                skillRange: 190,
                skillCooldown: 4500,
                color: '#4A90E2',
                projectileColor: '#1E90FF'
            }
        };

        // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù
        document.querySelectorAll('.pokemon-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.pokemon-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedPokemon = this.dataset.pokemon;
                checkStartButton();
            });
        });

        document.getElementById('trainerName').addEventListener('input', checkStartButton);

        function checkStartButton() {
            const nameInput = document.getElementById('trainerName').value.trim();
            if (nameInput && selectedPokemon) {
                document.getElementById('startBtn').disabled = false;
            } else {
                document.getElementById('startBtn').disabled = true;
            }
        }

        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', () => {
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        });

        document.getElementById('showLeaderboardBtn').addEventListener('click', showLeaderboard);
        document.getElementById('showLeaderboardBtn2').addEventListener('click', showLeaderboard);
        document.getElementById('closeLeaderboardBtn').addEventListener('click', () => {
            document.getElementById('leaderboardScreen').classList.add('hidden');
            if (gameState === 'menu') {
                document.getElementById('startScreen').classList.remove('hidden');
            } else {
                document.getElementById('gameOverScreen').classList.remove('hidden');
            }
        });

        async function showLeaderboard() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('leaderboardScreen').classList.remove('hidden');
            document.getElementById('leaderboardLoading').style.display = 'block';
            document.getElementById('leaderboardList').innerHTML = '';

            const scores = await window.loadLeaderboard();
            
            document.getElementById('leaderboardLoading').style.display = 'none';

            if (scores.length === 0) {
                document.getElementById('leaderboardList').innerHTML = '<p style="color: white; text-align: center;">ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            const listHtml = scores.map((score, index) => {
                const rank = index + 1;
                const isTop3 = rank <= 3;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                
                return `
                    <div class="leaderboard-item ${isTop3 ? 'top3' : ''}">
                        <div class="rank">${medal || rank}</div>
                        <div class="trainer-info">
                            <div class="trainer-name">${score.trainerName}</div>
                            <div class="trainer-pokemon">${score.pokemon} | ${score.town}</div>
                        </div>
                        <div class="score">Lv.${score.level}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('leaderboardList').innerHTML = listHtml;
        }

        // D-Ìå®Îìú Ïª®Ìä∏Î°§
        const directions = {
            up: false,
            down: false,
            left: false,
            right: false
        };

        ['btnUp', 'btnDown', 'btnLeft', 'btnRight'].forEach(btnId => {
            const btn = document.getElementById(btnId);
            const dir = btnId.replace('btn', '').toLowerCase();
            
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                directions[dir] = true;
            });
            
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                directions[dir] = false;
            });
        });

        // Í≥µÍ≤©/Ïä§ÌÇ¨
        let lastAttackTime = 0;
        let lastSkillTime = 0;
        let skillCooldownRemaining = 0;

        document.getElementById('attackBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            performAttack();
        });

        document.getElementById('skillBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            performSkill();
        });

        function startGame() {
            trainerNameValue = document.getElementById('trainerName').value.trim();
            if (!trainerNameValue || !selectedPokemon) return;

            const pokemonInfo = pokemonData[selectedPokemon];
            player = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                size: 30,
                hp: pokemonInfo.maxHp,
                maxHp: pokemonInfo.maxHp,
                invulnerable: 0,
                direction: 'down',
                frame: 0,
                ...pokemonInfo
            };

            enemies = [];
            projectiles = [];
            particles = [];
            level = 1;
            exp = 0;
            expToNextLevel = 100;
            kills = 0;
            currentTown = 0;
            lastAttackTime = 0;
            lastSkillTime = 0;

            document.getElementById('pokemonName').textContent = pokemonInfo.name;
            document.getElementById('townName').textContent = towns[0].name;
            
            showLocationScreen();
            spawnEnemies();
            updateUI();

            gameState = 'playing';
            document.getElementById('startScreen').classList.add('hidden');
            
            gameLoop();
        }

        function showLocationScreen() {
            showingLocation = true;
            const popup = document.createElement('div');
            popup.className = 'location-info';
            popup.innerHTML = `
                <h2>${towns[currentTown].name}</h2>
                <p>ÏÉàÎ°úÏö¥ ÏßÄÏó≠Ïóê ÎèÑÏ∞©ÌñàÏäµÎãàÎã§!</p>
            `;
            document.getElementById('gameContainer').appendChild(popup);

            setTimeout(() => {
                popup.remove();
                showingLocation = false;
            }, 2000);
        }

        let enemySpawnTimer = 0;

        function spawnEnemies() {
            enemySpawnTimer = Date.now();
        }

        function spawnEnemy() {
            const side = Math.floor(Math.random() * 4);
            let x, y;

            const margin = 50;
            switch(side) {
                case 0: x = Math.random() * canvas.width; y = -margin; break;
                case 1: x = canvas.width + margin; y = Math.random() * canvas.height; break;
                case 2: x = Math.random() * canvas.width; y = canvas.height + margin; break;
                case 3: x = -margin; y = Math.random() * canvas.height; break;
            }

            const wildPokemon = [
                { icon: 'üëæ', hp: 20 + currentTown * 10, speed: 1.5, size: 20, color: '#e74c3c', damage: 5 + currentTown * 2, expReward: 15 },
                { icon: 'ü¶á', hp: 30 + currentTown * 15, speed: 2, size: 22, color: '#8e44ad', damage: 8 + currentTown * 3, expReward: 20 },
                { icon: 'üëª', hp: 40 + currentTown * 20, speed: 1.2, size: 24, color: '#3498db', damage: 10 + currentTown * 4, expReward: 25 }
            ];

            const typeIndex = Math.min(currentTown, 2);
            const enemyType = wildPokemon[typeIndex];

            enemies.push({
                x, y,
                ...enemyType,
                maxHp: enemyType.hp
            });
        }

        function performAttack() {
            const now = Date.now();
            if (now - lastAttackTime < player.attackCooldown) return;
            lastAttackTime = now;

            const nearestEnemy = findNearestEnemy();
            if (!nearestEnemy) return;

            const dx = nearestEnemy.x - player.x;
            const dy = nearestEnemy.y - player.y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            projectiles.push({
                x: player.x,
                y: player.y,
                vx: (dx / dist) * 8,
                vy: (dy / dist) * 8,
                damage: player.attackDamage,
                size: 8,
                color: player.projectileColor,
                maxDist: player.attackRange,
                traveled: 0
            });
        }

        function performSkill() {
            const now = Date.now();
            if (now - lastSkillTime < player.skillCooldown) return;
            lastSkillTime = now;

            enemies.forEach(enemy => {
                const dx = enemy.x - player.x;
                const dy = enemy.y - player.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < player.skillRange) {
                    enemy.hp -= player.skillDamage;
                    createParticles(enemy.x, enemy.y, player.color, 15);

                    if (enemy.hp <= 0) {
                        killEnemy(enemy);
                    }
                }
            });

            createSkillEffect(player.x, player.y, player.skillRange, player.color);
        }

        function findNearestEnemy() {
            let nearest = null;
            let minDist = Infinity;

            enemies.forEach(enemy => {
                const dx = enemy.x - player.x;
                const dy = enemy.y - player.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < minDist) {
                    minDist = dist;
                    nearest = enemy;
                }
            });

            return nearest;
        }

        function killEnemy(enemy) {
            const index = enemies.indexOf(enemy);
            if (index > -1) {
                enemies.splice(index, 1);
                kills++;
                
                exp += enemy.expReward;

                checkLevelUp();
                updateUI();

                createParticles(enemy.x, enemy.y, enemy.color, 20);
            }
        }

        function checkLevelUp() {
            while (exp >= expToNextLevel) {
                exp -= expToNextLevel;
                level++;
                expToNextLevel = Math.floor(expToNextLevel * 1.5);
                
                player.hp = Math.min(player.maxHp, player.hp + 20);
                player.attackDamage += 5;
                
                showLevelUpPopup();
                
                // 5Î†àÎ≤®ÎßàÎã§ Îã§Ïùå ÎßàÏùÑÎ°ú
                if (level % 5 === 0 && currentTown < towns.length - 1) {
                    currentTown++;
                    document.getElementById('townName').textContent = towns[currentTown].name;
                    showLocationScreen();
                }
                
                updateUI();
            }
        }

        function showLevelUpPopup() {
            const popup = document.createElement('div');
            popup.className = 'level-up-popup';
            popup.innerHTML = `
                <h2>Î†àÎ≤® ÏóÖ!</h2>
                <p>Î†àÎ≤® ${level}</p>
            `;
            document.getElementById('gameContainer').appendChild(popup);

            setTimeout(() => {
                popup.remove();
            }, 2000);
        }

        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 0.5) * 6,
                    life: 30,
                    maxLife: 30,
                    size: 3 + Math.random() * 3,
                    color
                });
            }
        }

        function createSkillEffect(x, y, range, color) {
            for (let i = 0; i < 40; i++) {
                const angle = (Math.PI * 2 / 40) * i;
                particles.push({
                    x: x + Math.cos(angle) * range,
                    y: y + Math.sin(angle) * range,
                    vx: Math.cos(angle) * 3,
                    vy: Math.sin(angle) * 3,
                    life: 25,
                    maxLife: 25,
                    size: 6,
                    color
                });
            }
        }

        function gameLoop() {
            if (gameState !== 'playing') return;

            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            if (showingLocation) return;

            // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Îèô
            let moving = false;
            if (directions.up) {
                player.y -= player.speed;
                player.direction = 'up';
                moving = true;
            }
            if (directions.down) {
                player.y += player.speed;
                player.direction = 'down';
                moving = true;
            }
            if (directions.left) {
                player.x -= player.speed;
                player.direction = 'left';
                moving = true;
            }
            if (directions.right) {
                player.x += player.speed;
                player.direction = 'right';
                moving = true;
            }

            if (moving) {
                player.frame = (player.frame + 0.2) % 2;
            }

            player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
            player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));

            if (player.invulnerable > 0) player.invulnerable--;

            // Ï†Å Ïä§Ìè∞
            if (Date.now() - enemySpawnTimer > towns[currentTown].enemySpawnRate) {
                spawnEnemy();
                enemySpawnTimer = Date.now();
            }

            // Î∞úÏÇ¨Ï≤¥
            projectiles = projectiles.filter(proj => {
                proj.x += proj.vx;
                proj.y += proj.vy;
                proj.traveled += Math.sqrt(proj.vx * proj.vx + proj.vy * proj.vy);

                if (proj.traveled > proj.maxDist) return false;
                if (proj.x < 0 || proj.x > canvas.width || proj.y < 0 || proj.y > canvas.height) return false;

                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    const dx = proj.x - enemy.x;
                    const dy = proj.y - enemy.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < enemy.size + proj.size) {
                        enemy.hp -= proj.damage;
                        createParticles(enemy.x, enemy.y, enemy.color, 5);

                        if (enemy.hp <= 0) {
                            killEnemy(enemy);
                        }

                        return false;
                    }
                }

                return true;
            });

            // Ï†Å Ïù¥Îèô
            enemies.forEach(enemy => {
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist > 0) {
                    enemy.x += (dx / dist) * enemy.speed;
                    enemy.y += (dy / dist) * enemy.speed;
                }

                if (dist < player.size + enemy.size && player.invulnerable === 0) {
                    player.hp -= enemy.damage;
                    player.invulnerable = 60;
                    updateUI();

                    if (player.hp <= 0) {
                        gameOver();
                    }
                }
            });

            // ÌååÌã∞ÌÅ¥
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.15;
                p.life--;
                return p.life > 0;
            });

            // Ïä§ÌÇ¨ Ïø®Îã§Ïö¥
            if (Date.now() - lastSkillTime < player.skillCooldown) {
                skillCooldownRemaining = Math.ceil((player.skillCooldown - (Date.now() - lastSkillTime)) / 1000);
                document.getElementById('skillCooldown').textContent = skillCooldownRemaining;
                document.getElementById('skillCooldown').classList.remove('hidden');
            } else {
                document.getElementById('skillCooldown').classList.add('hidden');
            }
        }

        function render() {
            const town = towns[currentTown];
            
            // Î∞∞Í≤Ω
            ctx.fillStyle = town.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Í∏∏
            ctx.fillStyle = town.pathColor;
            for (let i = 0; i < canvas.width; i += 100) {
                ctx.fillRect(i + 30, 0, 40, canvas.height);
            }
            for (let i = 0; i < canvas.height; i += 100) {
                ctx.fillRect(0, i + 30, canvas.width, 40);
            }

            // ÎÇòÎ¨¥
            for (let i = 0; i < 10; i++) {
                const tx = (i * 123 + 50) % canvas.width;
                const ty = (i * 87 + 50) % canvas.height;
                
                // ÎÇòÎ¨¥ Í∑∏Î¶ºÏûê
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.beginPath();
                ctx.ellipse(tx, ty + 35, 15, 5, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // ÎÇòÎ¨¥ Î™∏ÌÜµ
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(tx - 5, ty + 10, 10, 25);
                
                // ÎÇòÎ¨¥ Ïûé
                ctx.fillStyle = town.treeColor;
                ctx.beginPath();
                ctx.arc(tx, ty, 20, 0, Math.PI * 2);
                ctx.fill();
            }

            // Ïßë
            for (let i = 0; i < 3; i++) {
                const hx = (i * 250 + 100) % canvas.width;
                const hy = (i * 150 + 100) % canvas.height;
                
                // Ïßë Í∑∏Î¶ºÏûê
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.fillRect(hx + 5, hy + 45, 60, 5);
                
                // Ïßë Î™∏Ï≤¥
                ctx.fillStyle = town.houseColor;
                ctx.fillRect(hx, hy + 20, 60, 30);
                
                // ÏßÄÎ∂ï
                ctx.fillStyle = '#8B0000';
                ctx.beginPath();
                ctx.moveTo(hx - 5, hy + 20);
                ctx.lineTo(hx + 30, hy - 10);
                ctx.lineTo(hx + 65, hy + 20);
                ctx.fill();
                
                // Î¨∏
                ctx.fillStyle = '#654321';
                ctx.fillRect(hx + 20, hy + 30, 20, 20);
                
                // Ï∞ΩÎ¨∏
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(hx + 5, hy + 25, 10, 10);
                ctx.fillRect(hx + 45, hy + 25, 10, 10);
            }

            // ÌååÌã∞ÌÅ¥
            particles.forEach(p => {
                const alpha = p.life / p.maxLife;
                ctx.fillStyle = p.color;
                ctx.globalAlpha = alpha;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Î∞úÏÇ¨Ï≤¥
            projectiles.forEach(proj => {
                ctx.fillStyle = proj.color;
                ctx.shadowBlur = 15;
                ctx.shadowColor = proj.color;
                ctx.beginPath();
                ctx.arc(proj.x, proj.y, proj.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Ï†Å
            enemies.forEach(enemy => {
                // Í∑∏Î¶ºÏûê
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.ellipse(enemy.x, enemy.y + enemy.size + 3, enemy.size * 0.8, enemy.size * 0.3, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.size, 0, Math.PI * 2);
                ctx.fill();

                ctx.font = `${enemy.size * 1.5}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enemy.icon, enemy.x, enemy.y);

                // HP Î∞î
                const barWidth = enemy.size * 2;
                const hpPercent = enemy.hp / enemy.maxHp;

                ctx.fillStyle = '#333';
                ctx.fillRect(enemy.x - barWidth / 2, enemy.y - enemy.size - 12, barWidth, 4);
                
                ctx.fillStyle = hpPercent > 0.5 ? '#4CAF50' : '#e74c3c';
                ctx.fillRect(enemy.x - barWidth / 2, enemy.y - enemy.size - 12, barWidth * hpPercent, 4);
            });

            // ÌîåÎ†àÏù¥Ïñ¥
            if (player.invulnerable === 0 || Math.floor(Date.now() / 100) % 2 === 0) {
                // Í∑∏Î¶ºÏûê
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.ellipse(player.x, player.y + player.size + 5, player.size * 0.7, player.size * 0.25, 0, 0, Math.PI * 2);
                ctx.fill();

                // ÌîåÎ†àÏù¥Ïñ¥ Ìè¨ÏºìÎ™¨ Í∑∏Î¶¨Í∏∞
                drawPokemon(ctx, player.type, player.x, player.y, player.size);
            }
        }

        function updateUI() {
            const hpPercent = (player.hp / player.maxHp) * 100;
            const hpBar = document.getElementById('hpBar');
            hpBar.style.width = Math.max(0, hpPercent) + '%';
            hpBar.textContent = `${Math.max(0, Math.floor(player.hp))}/${player.maxHp}`;
            
            if (hpPercent < 30) {
                hpBar.classList.add('low');
            } else {
                hpBar.classList.remove('low');
            }

            document.getElementById('levelDisplay').textContent = `Î†àÎ≤®: ${level}`;
            
            const expPercent = (exp / expToNextLevel) * 100;
            document.getElementById('expBar').style.width = expPercent + '%';
        }

        async function gameOver() {
            gameState = 'gameover';
            
            await window.saveScore(trainerNameValue, pokemonData[selectedPokemon].name, level, towns[currentTown].name, kills);
            
            document.getElementById('finalLevel').textContent = level;
            document.getElementById('finalTown').textContent = towns[currentTown].name;
            document.getElementById('finalKills').textContent = kills;
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }
    </script>
</body>
</html>
